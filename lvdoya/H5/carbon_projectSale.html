<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no">
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<title>买进</title>		
		<style>
			body {
				margin: 0;
				background-color: #f0f0f2;
				font-family: sans-serif;
				/*overflow: hidden;*/ /* this is important to prevent the whole page to bounce FOR iScorll */
			}
			.div_carbonProjectBuySaleUserLogo{
				width: 100%; text-align: center;
			}
			.div_carbonProjectBuySaleUserLogo img {
				width: 70px; height: 70px; border-radius: 50%; margin-top: 10px;
			}
			.txt_carbonProjectInputAmount{
				width: 80%; height: 50px; -webkit-appearance: none; border: none; padding: 0px; border-radius: 0px; font-size: 20px; margin-left: 10px; color: #000000;
			}
		</style>
	</head>
	<link rel="stylesheet" type="text/css" href="css/weui.css">
	<script type="text/javascript" src="js/jquery-3.1.1.min.js" ></script>
	<script type="text/javascript" src="js/iscroll-probe.js"></script>
	<script type="text/javascript" src="js/fastclick.js"></script>
	<script src="js/functionPublic.js"></script>
	<body onload="init();">
		<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:45px; background-color:#1AAD19; position:fixed; top:0px; z-index:8888;">
			<tr>
				<td style="width:40px; text-align:center; vertical-align:middle;" onclick="go_back()"><img src="ico/ico_back.png" style="max-width:26px;" /></td>
				<td style="width: 36px;">&nbsp;</td>
				<td style="text-align:center; font-size:16px; color:#fff;">卖出</td>
				<td style="width:76px; vertical-align:middle; text-align:center; color: #FFFFFF;">
					<div id="div_IWantSale" style="width:100%; height: 45px; line-height: 45px; font-size: 14px; text-align: center;">&nbsp;</div>
				</td>
			</tr>
		</table>
		
		<div style="width:100%; background-color: #fff; height: 40px; line-height: 40px; margin-top: 45px; overflow: hidden;" onclick="goCarbonInfo();">
			<font style="margin-left: 10px; font-size: 16px;" id="font_ccerName">&nbsp;</font>			
		</div>
		
		<div style="width: 100%; margin-top: 5px; background-color: #FFFFFF; padding-bottom: 5px;">
			<div id="div_carbonProjectBuySaleUserLogo" class="div_carbonProjectBuySaleUserLogo">&nbsp;</div>
			<div id="div_carbonProjectBuySaleUserNickname" style="width: 100%; height: 20px; line-height: 20px; text-align: center; font-size: 14px; color: #666666;">lvdoya</div>
			<div style="width: 100%; height: 20px; line-height: 20px; text-align: center; font-size: 14px; color: #333333; margin-top: 5px;">收购:<font id="font_carbonPorjectBuyAmount" style="font-size: 18px; font-weight: bold;">0</font>吨</div>
			<div style="width: 100%; height: 20px; line-height: 20px; text-align: center; font-size: 14px; color: #333333; margin-top: 5px;">单价:<font id="font_carbonPorjectBuyPrice" style="font-size: 18px; font-weight: bold;">0.00</font>碳票/吨</div>
		</div>
		
		<div style="width: 100%; height: 50px; background-color: #FFFFFF; border-top: 5px solid #f0f0f2;">
			<input type="number" class="txt_carbonProjectInputAmount" id="txt_carbonProjectInputAmount" onfocus="if(this.value==0){this.value='';}" value="0" onblur="if(this.value==''){this.value=0;}" oninput="txtChange(this);" />
			<div style="float: right; margin-right: 10px; height: 50px; line-height: 50px;">吨</div>
		</div>
		
		<div style="width: 100%; height: 160px; background: #F2F2F0;"></div>
		
		<div id="div_carbonProjectBuySaleBottom" style="width: 100%; position: absolute; bottom: 0px; height: 50px; background-color: #FFFFFF; border-top: 1px solid #CCCCCC; z-index: -1;">
			<div style="width: 100px; height: 50px; line-height: 50px; color: #FFFFFF; background-color: #1AAD19; text-align: center; float: right; margin-right: 0px;" onclick="clickPay();">确认卖出</div>
			<div id="div_paySum" style="float: right; height: 50px; line-height: 50px; text-align: center;">共可收入:<font id="font_carbonBuyPaySum">0.00</font>碳票</div>
		</div>
	</body>
</html>


<!--============================================================================================================-->
<div id="loadingToast" class="weui_loading_toast" style="display:none; z-index:999999;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p id="p_loadContent" class="weui_toast_content">正在加载</p>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogDone" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle">提示</strong></div>
        <div id="dialogContent" class="weui_dialog_bd" style="font-weight: bold;">卖出成功</div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:goAccount();" class="weui_btn_dialog default">去账户</a>
            <a id="dialogConfirm" href="javascript:goClose();" class="weui_btn_dialog primary">返回</a>
        </div>
    </div>
</div>
<!--============================================================================================================-->


<!--========================================================================================================-->
<div class="weui_dialog_alert" id="notice" style="display:none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">提示</strong></div>
        <div class="weui_dialog_bd" id="noticeContent">&nbsp;</div>
        <div class="weui_dialog_ft">
            <a href="javascript:$('#notice').css('display','none');" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>


<!--BEGIN actionSheetPassword-->
<div class="weui_dialog_confirm" id="dialogPassword" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle">提示</strong></div>
        <div id="dialogContent" class="weui_dialog_bd">你还未设置安全密码</div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogPassword').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:go_setPassword();" class="weui_btn_dialog primary">去设置</a>
        </div>
    </div>
</div>

<style>
	.txt_password
	{
		width:100%;	height:50px; border-radius:0px;	border:none; color:#000; font-size:40px; padding:0px; -webkit-appearance: none; margin-top:5px; margin-bottom:10px; text-align:center; margin-top:5px;
	}
	.tablePassword
	{
		background-color:#fff;
	}
	.tablePassword td
	{
		width:33%; height:50px; vertical-align:middle; text-align:center; font-size:20px; border-bottom:1px solid #f2f2f2; border-right:1px solid #f2f2f2;
	}
</style>

<div id="actionSheet_wrapPassword" style="z-index:9999;">
    <div class="weui_mask_transition" id="maskPassword"></div>
    <div class="weui_actionsheet" id="weui_actionsheetPassword">
    <div style="width:100%; height:50px; line-height:50px; font-size:16px; color:#1AAD19; text-align:center; font-weight:bold;">请输入安全密码</div>
    <div style="width:100%; height:60px; text-align:center;"><input id="txt_password" type="password" class="txt_password" readonly="true" /></div>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tablePassword">
      <tr>
        <td onclick="typePassword(this);">1</td>
        <td onclick="typePassword(this);">2</td>
        <td onclick="typePassword(this);">3</td>
      </tr>
      <tr>
        <td onclick="typePassword(this);">4</td>
        <td onclick="typePassword(this);">5</td>
        <td onclick="typePassword(this);">6</td>
      </tr>
      <tr>
        <td onclick="typePassword(this);">7</td>
        <td onclick="typePassword(this);">8</td>
        <td onclick="typePassword(this);">9</td>
      </tr>    
      <tr>
        <td onclick="" style="font-size:10px; color:#8a8a8a;">&nbsp;</td>
        <td onclick="typePassword(this);">0</td>
        <td onclick="typePassword(this);">×</td>
      </tr>         
    </table>	       
    </div>
</div>

<script src="js/tripledes.js"></script>
<script src="js/mode-ecb.js"></script>
<script>
var key = CryptoJS.enc.Utf8.parse("huangkaishitemegedahaoren");  
var iv  = CryptoJS.enc.Utf8.parse("BrTc2404");

function showActionSheetPassword() {
	$("#txt_password").val("");	
	var maskPassword = $('#maskPassword');
	var weuiActionsheetPassword = $('#weui_actionsheetPassword');
	weuiActionsheetPassword.addClass('weui_actionsheet_toggle');
	maskPassword.show().addClass('weui_fade_toggle').click(function() {
		hideActionSheetPassword(weuiActionsheetPassword, maskPassword);
	});
	weuiActionsheetPassword.unbind('transitionend').unbind('webkitTransitionEnd');
}

function hideActionSheetPassword() {
	$("#loadingToast").css("display", "none");
	var maskPassword = $('#maskPassword');
	var weuiActionsheetPassword = $('#weui_actionsheetPassword');

	weuiActionsheetPassword.removeClass('weui_actionsheet_toggle');
	maskPassword.removeClass('weui_fade_toggle');
	weuiActionsheetPassword.on('transitionend', function() {
		maskPassword.hide();
	}).on('webkitTransitionEnd',
		function() {
			maskPassword.hide();
		})
}

function typePassword(obj) {
	if($(obj).html() != "×") {
		typeNumber = $(obj).html();
		typed = $("#txt_password").val();
		$("#txt_password").val(typed + typeNumber);
		if($("#txt_password").val().length == 6) {
			ccerSale();
		}
	} else {
		typeLength = $("#txt_password").val().length;
		typeed = $("#txt_password").val();
		$("#txt_password").val(typed.substring(0, typeLength - 1));
	}
}

function Encrypt(word) {
	srcs = CryptoJS.enc.Utf8.parse(word);
	var encrypted = CryptoJS.TripleDES.encrypt(srcs, key, {
		iv: iv,
		mode: CryptoJS.mode.CBC,
		padding: CryptoJS.pad.Pkcs7
	});
	return encrypted;
}

function go_setPassword(){
	aif.javaGoSetPassword();
}
</script>
<!--END actionSheetPassword-->
<!--END=====================================================================================================-->

<script>
//UI
$("#div_paySum").css("width",$(window).width()-100+"px")
//END UI

$(function() {    
    FastClick.attach(document.body); 		//FastClick插件，提高点击速度   
}); 

var token=GetUrlParam("token");
var orderId=GetUrlParam("orderId");

function go_back(){
	history.go(-1);
}

function goClose(){
	aif.javaCloseActivity();
}

function goAccount(){
	var newUrl="http://www.lvdoya.com/H5/accountCarbon.html?token="+token;
	aif.javaOpenNewWindow(newUrl);
	aif.javaCloseActivity();
}

function goCarbonInfo(){
	window.location="carbon_info.html?ccerNumber="+ccerNumber;
}

function init(){
	$("#loadingToast").css("display","block");
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/cshop/getCcerByccerId?callback=?&ccerId="+orderId,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				$("#font_ccerName").html(json.data.c_title);
				$("#div_carbonProjectBuySaleUserLogo").html("<img src='"+json.data.user_logo+"' />");
				$("#div_carbonProjectBuySaleUserNickname").html(json.data.nname);
				$("#font_carbonPorjectBuyAmount").html(json.data.yl);
				$("#font_carbonPorjectBuyPrice").html(json.data.price);
				$("#loadingToast").css("display","none");
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});	
	
}

function txtChange(obj) {
	var price=$("#font_carbonPorjectBuyPrice").html();
	$("#font_carbonBuyPaySum").html(parseFloat(price * obj.value).toFixed(2));
}

function clickPay() {//	$("#txt_password").val("");
	
	tokenIsNull();
	
	var inputAmount=$("#txt_carbonProjectInputAmount").val();
	
	if (inputAmount=="0") {
//		jectNotice("请输入卖出数量");
		aif.javaToastNotice("请输入卖出数量");
		return;
	}
	
	if (parseInt(inputAmount)>parseInt($("#font_carbonPorjectBuyAmount").html())){
//		jectNotice("卖出数量不能大于收购数量");
		aif.javaToastNotice("卖出数量不能大于收购数量");
		return;
	}
	
	if (inputAmount.indexOf(".")>0){
//		jectNotice("只能输入整数");
		aif.javaToastNotice("只能输入整数");
		return;
	}
	queryPassword();
}

function queryPassword()
{
	if (token==null || token==""){
		jectNotice("登录已过期");
		return;
	}		
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/user/checkSecPwdToJSON?callback=?&token="+token,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				if (json.data==1){ //已设置
					showActionSheetPassword();		
					$("#loadingToast").css("display","none");	
				} else {
					$("#dialogPassword").css("display","block");
				}					
			}
			else
			{				
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});	
}

function ccerSale(){
	if (token==null || token==""){
		jectNotice("登录已过期");
		return;
	}
	
	var buyAmount=$("#txt_carbonProjectInputAmount").val();
	var payPwd="";
	payPwd=$("#txt_password").val();
	payPwd=Encrypt(payPwd)+"";
	
	//必须对+和&进行转义替换，否则服务端接收后会变成空格
    payPwd = payPwd.replace(/\+/g,"%2B");
    payPwd = payPwd.replace(/\&/g,"%26"); 
	//END //必须对+和&进行转义替换，否则服务端接收后会变成空格	
	
	console.log(orderId+"/"+token+"/"+payPwd+"/"+buyAmount);
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/cshop/ccerSale?callback=?&token="+token+"&ccerId="+orderId+"&payPwd="+payPwd+"&sl="+buyAmount,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				hideActionSheetPassword();
//				jectNotice("买进成功");
				$("#dialogDone").css("display","block");
			}
			else
			{
				hideActionSheetPassword();
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			jectNotice("出错啦");
			$("#loadingToast").css("display","none");
		}
	});
}

</script>
