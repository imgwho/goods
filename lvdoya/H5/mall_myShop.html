<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no">  <!-- minimum-scale=0.5, maximum-scale=2.0,-->
<title>myShop</title>
<style>
body
{
	margin:0;
	background-color:#f0f0f2;
	font-family: sans-serif;
	overflow:hidden; /* this is important to prevent the whole page to bounce FOR iScorll */  
}
.tableTop {
	position:fixed;
	top:45px;
	border-bottom:1px solid #ccc;
	z-index:9998;
}
.tableTop td {
	width:33%;
	vertical-align:middle;
	text-align:center;
	height:45px;
	border-right:1px #ccc solid;
	background-color:#fff;
	font-size:12px;
}
.tableTop img {
	max-width:20px;
}
.tableBottom {
	position:fixed;
	bottom:0px;
	border-top:1px solid #ccc;
	background-color:#f8f8f8;
	z-index:7777;
}
.tableBottom td {
	width:50%;
	height:50px;
	vertical-align:middle;
	text-align:center;
	font-size:14px;
	color:#333;
}
.tableBottom img {
	max-width:20px;
	vertical-align:middle;
	margin-right:10px;
}
.td_goodsFace img
{
	width:80px; height:80px; vertical-align:middle;
}
.div_goodsFace img
{
	width:80px; height:80px; position:absolute; top:0px; left:0px;
}

		/*iScorll*/
		
		#wrapper {  
		    position: absolute;  
		    z-index: 1;  
		    top: 95px;  
		    bottom: 0px;  
		    left: 0;  
		    width: 100%;   
		    /*overflow: hidden; */ 
		}  
		  
		#scroller {  
		    position: absolute;  
		    z-index: 1;  
		    -webkit-tap-highlight-color: rgba(0,0,0,0);  
			-webkit-transform:translate3d(0,0,0);
		    width: 100%;  
			min-height:100.25%;
		    -webkit-transform: translateZ(0);  
		    -moz-transform: translateZ(0);  
		    -ms-transform: translateZ(0);  
		    -o-transform: translateZ(0);  
		    transform: translateZ(0);  
		    -webkit-touch-callout: none;  
		    -webkit-user-select: none;  
		    -moz-user-select: none;  
		    -ms-user-select: none;  
		    user-select: none;  
		    -webkit-text-size-adjust: none;  
		    -moz-text-size-adjust: none;  
		    -ms-text-size-adjust: none;  
		    -o-text-size-adjust: none;  
		    text-size-adjust: none;  
		}  
		  
		#pullDown,#pullUp,.pulldown-tips{  
		    height:40px;  
		    line-height:40px;  
		    text-align:center; 
			background-color:#fff; 
			color:#979797;
			font-size:12px;
		}  
		.pulldown-tips{  
			position:absolute;  
			top:-40px;  
			left:0;  
			width:100%;
			display:none;
		}
		/*END iScorll*/		
</style>
</head>
<link rel="stylesheet" type="text/css" href="css/weui.css">
<script type="text/javascript" src="js/jquery-3.1.1.min.js" ></script>
<script type="text/javascript" src="js/iscroll-probe.js"></script>
<script src="js/functionPublic.js"></script>
<body onload="init();">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:45px; background-color:#1AAD19; position:fixed; top:0px; z-index:9999;">
  <tr>
    <td style="width:40px; text-align:center; vertical-align:middle;" onclick="closeCurrent();"><img src="ico/ico_back.png" style="max-width:26px;" /></td>
    <td style="text-align:center; font-size:16px; color:#fff;">我的店铺</td>
    <td style="width:40px; vertical-align:middle; text-align:center; font-size:12px; color:#fff;" onclick="go_setting();"><img src="ico/ico_setting_fff.png" style="max-height:20px;" /><br />设置</td>
  </tr>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0" class="tableTop">
  <tr>
    <td id="td_onSale" style="color:#259b24;" onclick="td_onSale();"><img src="ico/ico_onSale_1.png" /><br />出售中</td>
    <td id="td_offSale" onclick="td_offSale();"><img src="ico/ico_offSale_2.png" /><br />已下架</td>
    <td id="td_order" onclick="go_order();" style="border-right:none;"><img src="ico/ico_order_2.png" /><br />订单</td>
  </tr>
</table>
<div style="width:100%; height:95px;"></div>

<div id="wrapper"> 
<div id="scroller">
<div id="pullDown" class=""><div class="pullDownLabel"></div></div>
<div class="pulldown-tips">下拉刷新</div>

<div id="div_goodsContent">
    <div id="div_goodsContentOn1"></div>
    <div id="div_goodsContentOff1"></div>
</div>
<div style="width:100%; height:60px;"></div> <!--抵消Fixed高度-->

</div><!--scroller-->
</div><!--wrapper-->

<table width="100%" border="0" cellspacing="0" cellpadding="0" class="tableBottom">
  <tr>
    <td style="border-right:1px solid #ccc;" onclick="go_myShopView();"><img src="ico/ico_seeShop_1.png" />查看店铺</td>
    <td onclick="go_myShopAdd();"><img src="ico/ico_add_1.png" />添加新商品</td>
  </tr>
</table>
</body>
</html>

<!--BEGIN ==================================================================================================================================================-->
<div id="toast" style="display: none;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <i class="weui_icon_toast"></i>
        <p id="toastContent" class="weui_toast_content">保存成功</p>
    </div>
</div>

<div id="loadingToast" class="weui_loading_toast" style="display:none; z-index:999999;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p id="p_loadContent" class="weui_toast_content">正在加载</p>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogAskGoodsOff" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle"></strong>询问</div>
        <div id="dialogContent" class="weui_dialog_bd">是否下架该商品？</div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogAskGoodsOff').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:goodsOff();" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogAskGoodsOn" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle"></strong>询问</div>
        <div id="dialogContent" class="weui_dialog_bd">是否上架该商品？</div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogAskGoodsOn').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:goodsOn();" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogAskGoodsDel" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle"></strong>询问</div>
        <div id="dialogContent" class="weui_dialog_bd">是否删除该商品？删除后<font color="#FF0000">不可恢复</font></div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogAskGoodsDel').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:goodsDel();" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div class="weui_dialog_alert" id="notice" style="display:none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">提示</strong></div>
        <div class="weui_dialog_bd" id="noticeContent">&nbsp;</div>
        <div class="weui_dialog_ft">
            <a href="javascript:$('#notice').css('display','none');" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>
<!--END ==================================================================================================================================================-->

<script>
var token=GetUrlParam("token");
var userid=GetUrlParam("userid");
var goodsId="";
var pageNo=1;
var type="ON";
var scorllTime;

function closeCurrent(){
	aif.javaCloseActivity();
}

function init()
{
	url=window.location.href;
	saveFootprint(url);
	loadGoodsOn();
	setTimeout(function(){myScroll.refresh();},1000);
}

function td_onSale()
{
	type="ON";
	pageNo=1;
	$("#div_goodsContent").html("<div id='div_goodsContentOn1'></div><div id='div_goodsContentOff1'></div>");
	document.getElementById("td_onSale").style.color="#259b24";
	document.getElementById("td_onSale").innerHTML="<img src='ico/ico_onSale_1.png' /><br />出售中";	
	document.getElementById("td_offSale").style.color="#333";
	document.getElementById("td_offSale").innerHTML="<img src='ico/ico_offSale_2.png' /><br />已下架";
	loadGoodsOn();
}

function td_offSale()
{
	type="OFF";
	pageNo=1;
	$("#div_goodsContent").html("<div id='div_goodsContentOn1'></div><div id='div_goodsContentOff1'></div>");
	document.getElementById("td_onSale").style.color="#333";
	document.getElementById("td_onSale").innerHTML="<img src='ico/ico_onSale_2.png' /><br />出售中";	
	document.getElementById("td_offSale").style.color="#259b24";
	document.getElementById("td_offSale").innerHTML="<img src='ico/ico_offSale_1.png' /><br />已下架";
	loadGoodsOff();
}

function go_setting()
{
	window.location="mall_myShopSetting.html?token="+GetUrlParam("token")+"&userid="+GetUrlParam("userid");
}

function go_myShopView()
{
	window.location="mall_shop.html?token="+GetUrlParam("token")+"&userid="+GetUrlParam("userid");
}

function go_myShopAdd()
{
	window.location="mall_myShopGoodsAdd.html?token="+GetUrlParam("token");
}

function go_order()
{
	window.location="mall_shopOrder.html?token="+token;
}

function loadGoodsOn()
{
	$("#loadingToast").css("display","block");
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/getGoodsByUserid?callback=?&userId="+userid+"&status=0&pageNo="+pageNo,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){				
				var result="";
				
				if (json.data.length==0 && pageNo==1) {
					result="<div style='width:100%; text-align:center; margin-top:100px;'><img src='ico/ico_shopEmpty.png' style='max-height:100px; margin-bottom:10px;' /><br /><font style='font-size:14px; color:#8a8a8a;'>没有在售商品</font></div>";
				}
								
				for(var i=0; i<json.data.length; i++) {
					result+="<div id='div_goodsId"+json.data[i].spId+"' style='width:100%; background-color:#fff; margin-bottom:5px; border-top:1px solid #ccc; border-bottom:1px solid #ccc;'><table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td id='td_goodsFace' style='width:100px; vertical-align:middle; text-align:center;' class='td_goodsFace'>"+json.data[i].coverImg+"</td><td><div id='div_goodsName' style='width:100%; height:30px; line-height:40px; font-size:14px; overflow:hidden;'>"+json.data[i].title+"</div><div style='width:100%; height:40px; line-height:40px;'><font id='font_goodsPrice' style='font-size:18px; font-weight:bold; color:#1AAD19;'>"+parseFloat(json.data[i].normsJson[0].price).toFixed(2)+"</font><font style='font-size:14px;'>碳票</font></div><div style='width:100%; height:30px; line-height:20px; font-size:12px; color:#979797;'>积累销售<font id='font_goodsSaleNum'>"+json.data[i].count+"</font></div></td><td onClick='goodsEdit(&apos;"+json.data[i].spId+"&apos;);' style='width:40px; text-align:center; vertical-align:middle; font-size:12px; color:#8a8a8a;'><img src='ico/ico_edit.png' style='max-width:20px; vertical-align:middle;' /><br />编辑</td></tr></table><div style='margin-left:10px; margin-right:10px; height:1px; border:none; background-color:#e9e9e9;'></div><table width='100%' border='0' cellspacing='0' cellpadding='0' style='height:40px;'><tr><td onClick='goodsView(&apos;"+json.data[i].spId+"&apos;);' style='width:60px; vertical-align:middle; text-align:center; font-size:12px; color:#515151;'><img src='ico/ico_view_2.png' style='max-width:14px; vertical-align:middle; margin-right:5px;' />查看</td><td>&nbsp;</td> <td onClick='goodsOffAsk(&apos;"+json.data[i].spId+"&apos;);' style='width:60px; vertical-align:middle; text-align:center; font-size:12px; color:#d81e06;'><img src='ico/ico_down.png' style='max-width:14px; vertical-align:middle; margin-right:5px;' />下架</td></tr></table></div>";
				}
				var nextPageNo=parseInt(pageNo)+1;
				result+="<div id='div_goodsContentOn"+nextPageNo+"'></div>";
				$("#div_goodsContentOn"+pageNo).html(result);
//				var h=$("#div_goodsContent").height()+40+"px";
//				$("#div_goodsContent").css("height",h);
				pageNo++;
				$("#loadingToast").css("display","none");
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});		
}

function loadGoodsOff()
{
	$("#loadingToast").css("display","block");
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/getGoodsByUserid?callback=?&userId="+userid+"&status=9&page=1",data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				var result="";
				//alert(json.data.length);
				for(var i=0; i<json.data.length; i++) {
					result+="<div id='div_goodsId"+json.data[i].spId+"' style='width:100%; background-color:#fff; margin-bottom:5px; border-top:1px solid #ccc; border-bottom:1px solid #ccc;'><table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td style='width:100px;'><div style='width:80px; height:80px; margin:10px 10px 10px 10px; position:relative;'><div id='div_goodsFace' class='div_goodsFace' style='width:80px; height:80px; position:absolute; top:0px; left:0px;'>"+json.data[i].coverImg+"</div><div style='width:80px; height:80px; background-color:#000; opacity:0.6;'></div><img src='ico/ico_offSale.png' style='max-width:50%; position:absolute; top:3px; left:3px;' /></div></td><td><div id='div_goodsName' style='width:100%; height:30px; line-height:40px; font-size:14px; overflow:hidden;'>"+json.data[i].title+"</div><div style='width:100%; height:40px; line-height:40px;'><font id='font_goodsPrice' style='color:#1AAD19; font-size:18px; font-weight:bold;'>"+parseFloat(json.data[i].normsJson[0].price).toFixed(2)+"</font><font style='font-size:14px;'>碳票</font></div><div style='width:100%; height:30px; line-height:20px; font-size:12px; color:#979797;'>积累销售<font id='font_goodsSaleNum'>"+json.data[i].count+"</font></div></td><td onclick='goodsEdit(&apos;"+json.data[i].spId+"&apos;);' style='width:40px; text-align:center; vertical-align:middle; font-size:12px; color:#8a8a8a;'><img src='ico/ico_edit.png' style='max-width:20px; vertical-align:middle;' /><br />编辑</td></tr></table><div style='margin-left:10px; margin-right:10px; height:1px; border:none; background-color:#e9e9e9;'></div><table width='100%' border='0' cellspacing='0' cellpadding='0' style='height:40px;'><tr><td onclick='goodsOnAsk(&apos;"+json.data[i].spId+"&apos;);' style='width:60px; vertical-align:middle; text-align:center; font-size:12px; color:#259b24;'><img src='ico/ico_add.png' style='max-width:14px; vertical-align:middle; margin-right:5px;' />上架</td><td>&nbsp;</td><td onclick='goodsDelAsk(&apos;"+json.data[i].spId+"&apos;);' style='width:60px; vertical-align:middle; text-align:center; font-size:12px; color:#d81e06;'><img src='ico/ico_del.png' style='max-width:14px; vertical-align:middle; margin-right:5px;' />删除</td></tr></table></div>";
				}
				var nextPageNo=parseInt(pageNo)+1;
				result+="<div id='div_goodsContentOff"+nextPageNo+"'></div>";
				$("#div_goodsContentOff"+pageNo).html(result);
				$("#loadingToast").css("display","none");
				
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});		
}

function goodsEdit(gId)
{
	window.location="mall_myShopGoodsEdit.html?token="+token+"&goodsId="+gId;
}

function goodsOffAsk(spId)
{
	goodsId=spId;
	$("#dialogAskGoodsOff").css("display","block");
}

function goodsOnAsk(spId)
{
	goodsId=spId;
	$("#dialogAskGoodsOn").css("display","block");
}

function goodsDelAsk(spId)
{
	goodsId=spId
	$("#dialogAskGoodsDel").css("display","block");
}

function goodsOff()
{
	$("#loadingToast").css("display","block");
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/SetGoodsSoldout?callback=?&token="+token+"&spId="+goodsId+"&status=9",data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				$("#dialogAskGoodsOff").css("display","none");
				$("#div_goodsId"+goodsId).css("display","none");
				$("#loadingToast").css("display","none");
				
				$("#toastContent").html("下架成功");
				$("#toast").css("display","block");
				
				setTimeout(function(){$("#toast").css("display","none");},1500);
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});			
}

function goodsOn()
{
	$("#loadingToast").css("display","block");
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/SetGoodsSoldout?callback=?&token="+token+"&spId="+goodsId+"&status=0",data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				$("#dialogAskGoodsOn").css("display","none");
				$("#div_goodsId"+goodsId).css("display","none");
				$("#loadingToast").css("display","none");
				
				$("#toastContent").html("上架成功");
				$("#toast").css("display","block");
				
				setTimeout(function(){$("#toast").css("display","none");},1500);
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});			
}

function goodsDel()
{
	$("#loadingToast").css("display","block");
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/setGoodsDelete?callback=?&token="+token+"&spId="+goodsId,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				$("#dialogAskGoodsDel").css("display","none");
				$("#div_goodsId"+goodsId).css("display","none");
				$("#loadingToast").css("display","none");
				
				$("#toastContent").html("删除成功");
				$("#toast").css("display","block");
				
				setTimeout(function(){$("#toast").css("display","none");},1500);
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});			
}

function goodsView(spId)
{
	window.location="mall_goods.html?token="+token+"&goodsId="+spId;
}

//function iscorll () {  
	var myScroll,  
	pullDown = $("#pullDown"),  
	pullDownLabel = $(".pullDownLabel"),  

	loadingStep = 0;//加载状态0默认，1显示加载状态，2执行加载数据，只有当为0时才能再次加载，这是防止过快拉动刷新  
//  
	pullDown.hide();  

	myScroll = new IScroll("#wrapper", {  
		preventDefault:false,
		scrollbars: false,  
		mouseWheel: true,  
		interactiveScrollbars: true,  
		shrinkScrollbars: 'scale',  
		fadeScrollbars: true,  
		scrollY:true,  
		probeType: 2,  
		checkDOMChanges:true,
		bindToWrapper:true  
	});  
	myScroll.on("scroll",function(){  
		if(loadingStep == 0 && !pullDown.attr("class").match('refresh|loading')){  
			if(this.y > 40){//下拉刷新操作  
				$(".pulldown-tips").hide();  
				pullDown.addClass("refresh").show();  
				pullDownLabel.text("松手刷新数据");  
				loadingStep = 1;  
				myScroll.refresh();  				
			}else if(this.y < (this.maxScrollY - 60)){//上拉加载更多  
				loadingStep = 1;  
				$("#p_loadContent").html("正在加载");
				$("#loadingToast").css("display","block");
				pullUpAction();  
			}  
		}  
	});  
	myScroll.on("scrollEnd",function(){  
		if(loadingStep == 1){  
			if( pullDown.attr("class").match("refresh") ){//下拉刷新操作  
				pullDown.removeClass("refresh").addClass("loading");  
				$("#p_loadContent").html("正在刷新");
				$("#loadingToast").css("display","block");
				loadingStep = 2;  
				pullDownAction();  
			}  
		}  
	});  

	function pullDownAction(){  
		setTimeout(function(){  
			if (type=="ON") {
				td_onSale();
			} else if (type=="OFF") {
				td_offSale();
			}
			pullDown.attr('class','').hide();  
			loadingStep = 0;  
			$(".pulldown-tips").show(); 
			$("#loadingToast").css("display","none");
		},500);  
		setTimeout(function(){myScroll.refresh();},1000);
	}		
	function pullUpAction(){  
		setTimeout(function(){  
			loadingStep = 0;  
//			loadGoods();
			if (type=="ON") {
				loadGoodsOn();
			} else if (type=="OFF") {
				loadGoodsOff();
			}			
		},500);  
		setTimeout(function(){myScroll.refresh();},1000);
	}  

    document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);  
//}

</script>