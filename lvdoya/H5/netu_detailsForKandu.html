<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
	</head>
	<link rel="stylesheet" type="text/css" href="css/weui.css">
	<script type="text/javascript" src="js/jquery-3.1.1.min.js" ></script>
	<script type="text/javascript" src="js/iscroll-probe.js"></script>
	<script src="js/functionPublic.js"></script>
	</head>
	<style>
		body{
			background: #F2F2F0;
			font-family: sans-serif;
		}
		
		.tableBottom {
			position:fixed;
			bottom:0px;
			border-top:1px solid #ccc;
			background-color:#f8f8f8;
			z-index: 10;
		}
		.tableBottom td {
			width:50%;
			height:50px;
			vertical-align:middle;
			text-align:center;
			font-size:14px;
			color:#333;
		}
		.tableBottom img {
			max-width:20px;
			vertical-align:middle;
			margin-right:10px;
		}			
		.div_netuCover{
			width: 100%; text-align: center; background: #FFFFFF;
		}
		.div_netuCover img{
			width: 60%; margin-top: 60px;
		}
		.div_userLogo img{
			border-radius: 50%; width: 30px; height: 30px; margin-top: 10px;
		}
		
		/*iScorll*/
		
		#wrapper {  
		    position: absolute;  
		    z-index: 1;  
		    top: 50px;  
		    bottom: 0px;  
		    left: 0;  
		    width: 100%;   
		    /*overflow: hidden; */ 
		}  
		  
		#scroller {  
		    position: absolute;  
		    z-index: 1;  
		    -webkit-tap-highlight-color: rgba(0,0,0,0);  
			-webkit-transform:translate3d(0,0,0);
		    width: 100%;  
			min-height:100.25%;
		    -webkit-transform: translateZ(0);  
		    -moz-transform: translateZ(0);  
		    -ms-transform: translateZ(0);  
		    -o-transform: translateZ(0);  
		    transform: translateZ(0);  
		    -webkit-touch-callout: none;  
		    -webkit-user-select: none;  
		    -moz-user-select: none;  
		    -ms-user-select: none;  
		    user-select: none;  
		    -webkit-text-size-adjust: none;  
		    -moz-text-size-adjust: none;  
		    -ms-text-size-adjust: none;  
		    -o-text-size-adjust: none;  
		    text-size-adjust: none;  
		}  
		  
		#pullDown,#pullUp,.pulldown-tips{  
		    height:40px;  
		    line-height:40px;  
		    text-align:center; 
			background-color:#fff; 
			color:#979797;
			font-size:12px;
		}  
		.pulldown-tips{  
			position:absolute;  
			top:-40px;  
			left:0;  
			width:100%;
			display:none;
		}
		/*END iScorll*/		
	</style>
	<body onload="init();">
		<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:45px; background-color:#1AAD19; position:fixed; top:0px; z-index:8888;">
			<tr>
				<td id="td_bannerLeft" style="width:40px; text-align:center;" onclick="closeCurrent()"><img src="ico/ico_back.png" style="max-width:26px; margin-top: 7px;" /></td>
				<td id="td_bannerMiddle" style="text-align:center; font-size:16px; color:#fff;">碳中和</td>
				<td id="td_bannerRight" style="width:40px; text-align:center; font-size:12px; color:#fff;" onclick="shareNetu();">
					<img src="ico/ico_share_fff.png" style="max-height: 22px;" />
				</td>
			</tr>
		</table>
		<!--<div style="width: 100%; height: 50px;"></div>-->
		
		<!--<div id="wrapper"> 
		<div id="scroller">
		<div id="pullDown" class=""><div class="pullDownLabel"></div></div>
		<div class="pulldown-tips">下拉刷新</div>-->
		
		<div id="div_netuCover" class="div_netuCover"></div>
		<div style="width: 100%;">
			<div id="div_netuTitle" style="margin: 0px 10px 0px 10px; font-size: 16px; font-weight: bold; height: 50px; line-height: 50px; overflow: hidden; background: #f0f0f2;"></div>
		</div>
		<div id="div_key" style="width: 100%; height: 40px; background: #FFFFFF; border-bottom: 1px solid #E8E8E8; display: none;">
			<div style="width: auto; height: 40px; line-height: 40px; float: left; margin-left: 10px; font-size: 14px;">减排口令</div>
			<div id="div_netuCode" style="width: auto; height: 40px; line-height: 40px; float: left; margin-left: 10px; font-size: 18px; color: #FF9900; font-weight: bold;"></div>
		</div>		
		<div style="width: 100%; height: 40px; background: #FFFFFF; border-bottom: 1px solid #E8E8E8;">
			<div style="width: auto; height: 40px; line-height: 40px; font-size: 14px; margin-left: 10px; float: left; color: #979797;">计划中和:</div>
			<div id="div_planNetu" style="width: auto; height: 40px; line-height: 40px; font-size: 16px; margin-left: 10px; float: left;"></div>
		</div>		
		
		<div style="width: 100%; height: 40px; background: #FFFFFF; border-bottom: 1px solid #E8E8E8;">
			<div style="width: auto; height: 40px; line-height: 40px; font-size: 14px; margin-left: 10px; float: left; color: #979797;">已&nbsp;&nbsp;中&nbsp;&nbsp;和:</div>
			<div id="div_doneNetu" style="width: auto; height: 40px; line-height: 40px; font-size: 16px; margin-left: 10px; float: left;"></div>
		</div>	
		
		<div style="width: 100%; height: 50px; background: #FFFFFF; margin-top: 10px; border-bottom: 1px solid #E8E8E8;">
			<div style="float: left; margin-left: 10px; height: 50px; line-height: 50px; font-size: 14px;">发起人</div>
			<div id="div_userLogo" class="div_userLogo" style="float: left; margin-left: 10px;"></div>
			<div id="div_userNickname" style="float: left; margin-left: 3px; height: 50px; line-height: 50px; font-size: 14px;"></div>
		</div>		
		<div style="width: 100%; height: 50px; background: #FFFFFF; border-bottom: 1px solid #E8E8E8;">
			<div style="float: left; margin-left: 10px; height: 50px; line-height: 50px; font-size: 14px;">参与本次碳中和，可获得</div>
			<div id="div_xyz" style="float: left; margin-left: 10px; height: 50px; line-height: 50px; font-size: 16px; font-weight: bold; color: #FF9900;"></div>
			<div style="float: left; margin-left: 10px; height: 50px; line-height: 50px; font-size: 14px;">碳信用值</div>
		</div>			
		
		<div style="width: 100%; height: 30px; line-height: 30px;">
			<font style="margin-left: 10px; font-size: 12px;">碳减排中和碳项目</font>
		</div>
		<div style="width: 100%; height: 40px; background: #FFFFFF; border-bottom: 1px solid #E8E8E8;">
			<div id="div_netuProject" style="width: auto; height: 40px; line-height: 40px; margin-left: 10px; float: left; overflow: hidden; font-size: 14px;"></div>
		</div>	
		
		<div style="width: 100%; height: 30px; line-height: 30px;">
			<font style="margin-left: 10px; font-size: 12px;">中和描述</font>
		</div>
		<div style="width: 100%; background: #FFFFFF; border-bottom: 1px solid #E8E8E8;">
			<div id="div_netuInfo" style="width: auto; line-height: 28px; margin-left: 10px; margin-right: 10px; font-size: 14px; word-break: break-word;"></div>
		</div>			
		
		<div style="width: 100%; height: 60px;"></div>
		
		<!--</div>--><!--scroller-->
		<!--</div>--><!--wrapper-->		
		
		<!--<div style="width: 100%; height: 50px; background: #FFFFFF; border-bottom: 1px solid #E8E8E8; margin-top: 5px;">
			<div style="width: auto; height: 50px; line-height: 50px; font-size: 16px; margin-left: 10px; font-weight: bold;">展会背景</div>
		</div>-->
		<!--<div style="width: 100%; line-height: 24px; font-size: 14px;">
			<div id="div_netuInfo" style="margin: auto 10px auto 10px; word-break: break-word;">
				
			</div>
		</div>-->
				
		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="tableBottom" id="tableBottom">
		  <tr>
		    <td id="td_viewNameList" style="border-right:1px solid #ccc;"><img src="ico/ico_seeShop_1.png" />查看中和名单</td>
		    <td id="td_inputKey" style="border-right:1px solid #ccc;" onclick="typeNetuCode();"><img src="ico/ico_type.png" />输入减排口令</td>		    
		  </tr>
		</table>		
	</body>
</html>

<!--============================================================================================================-->
<div id="loadingToast" class="weui_loading_toast" style="display:none; z-index:999999;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p id="p_loadContent" class="weui_toast_content">正在加载</p>
    </div>
</div>

<div class="weui_dialog_alert" id="notice" style="display:none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">提示</strong></div>
        <div class="weui_dialog_bd" id="noticeContent">&nbsp;</div>
        <div class="weui_dialog_ft">
            <a href="javascript:$('#notice').css('display','none');" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogInput" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle">请输入减排口令</strong></div>
        <div id="dialogContent" class="weui_dialog_bd" style="font-weight: bold; color: #000000;">
        	<input id="txt_dialogInput" type="text" maxlength="4" style="width: 99%; height: 40px; margin: 1px; font-size: 32px; padding:0px; -webkit-appearance: none; border: 1px solid #CCCCCC; border-radius: 0px; text-align: center;" />
        </div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:inputCancle();" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:inputSubmit();" class="weui_btn_dialog primary">确认</a>
        </div>
    </div>
</div>
<!--============================================================================================================-->

<script>
	token=GetUrlParam("token");
	netuId=GetUrlParam("netuId");
	fromPage=GetUrlParam("fromPage");
	actionType=GetUrlParam("actionType");
	
	var shareTitle="";
	var shareContent="";
	var shareUrl="";
	var shareImgUrl="";	
	
	function init(){
		$("#loadingToast").css("display","block");
		
		if (fromPage=="H5"){
			$("#td_bannerRight").html("&nbsp;");
		}
		
		if (actionType=="JOIN"){
			$("#td_inputKey").css("display","none");
			$("#div_key").css("display","block");
		}
		loadDetails();
	}
	
	function closeCurrent(){
		if (fromPage=="H5"){
			history.go(-1);	
		} else {
			aif.javaCloseActivity();
		}		
	}
	
	function typeNetuCode(){
		$("#dialogInput").css("display","block");
		$("#tableBottom").css("bottom","-60px");
		$("#txt_dialogInput").focus();
	}
	
	function inputCancle(){
		$("#dialogInput").css("display","none");
		$("#tableBottom").css("bottom","0px");		
	}
	
	function goUserSpace(userId){
		var newUrl="http://www.lvdoya.com/H5/user_space.html?token="+token+"&userId="+userId;
		aif.javaOpenNewWindow(newUrl);
	}
	
	function goCarbonInfo(ccerNumber){
		var newUrl="http://www.lvdoya.com/H5/carbon_info.html?ccerNumber="+ccerNumber;
		aif.javaOpenNewWindow(newUrl);		
	}
	
	function goNameList(netuId){		
		var newUrl="http://www.lvdoya.com/H5/netu_nameList.html?token="+token+"&netuId="+netuId;
		aif.javaOpenNewWindow(newUrl);
	}
	
	function goNameListH5(netuId){
		window.location="netu_nameList.html?token="+token+"&netuId="+netuId+"&fromPage=H5";
	}
	
	function shareNetu(){		
		aif.javaShare(shareTitle,shareContent,shareUrl,shareImgUrl);
	}	
	
	function loadDetails(){
		$.ajax	
		({
			type : "POST",url:"http://114.55.103.71:9006/ldy/neutral/getNeutralById?callback=?&neutralId="+netuId,data: {},dataType : "jsonp",	
			success : function(data) 
			{   
				var json = eval(data); 	
				if (json.code==200){
					var coverImgString=json.data.n_img;
					coverImgString=coverImgString.replace("/>","");
					coverImgString+=" id='img"+netuId+"' />"
					$("#div_netuCover").html(coverImgString);
					$("#div_netuTitle").html(json.data.n_title);
					$("#div_planNetu").html(parseFloat(json.data.sl).toFixed(2)+"吨");
					var netuDone=parseFloat(parseFloat(json.data.sl)-parseFloat(json.data.yl)).toFixed(2);
					$("#div_doneNetu").html(netuDone+"吨");
					$("#div_netuInfo").html(json.data.n_info);
					$("#div_userLogo").html("<img src='"+json.data.user_logo+"' />")
					$("#div_userNickname").html(json.data.user_nickname);
					//--------------------
					if (json.data.user_nickname=="镇江国际低碳大会") {
						$("#div_userNickname").css("color","#FF0000");
					}
					//--------------------
					$("#div_netuProject").html("("+json.data.cnumber+")"+json.data.c_title);
					$("#div_netuCode").html(json.data.code);
					$("#div_xyz").html(json.data.xyz);
					
					$("#div_userLogo").attr("onclick","goUserSpace('"+json.data.userId+"');");
					$("#div_userNickname").attr("onclick","goUserSpace('"+json.data.userId+"');");
					$("#div_netuProject").attr("onclick","goCarbonInfo('"+json.data.cnumber+"');");
					if (fromPage=="H5"){
						$("#td_viewNameList").attr("onclick","goNameListH5('"+json.data.neutralId+"');");
					} else {
						$("#td_viewNameList").attr("onclick","goNameList('"+json.data.neutralId+"');");	
					}					
					
					if (parseFloat(json.data.yl).toFixed(2)==0.00 || json.data.status==1){
						$("#td_inputKey").css("display","none");
					}
					
					//为分享添加参数
					shareTitle="'"+json.data.user_nickname+"'在绿豆芽发起了"+parseFloat(json.data.sl).toFixed(2)+"吨碳中和-"+json.data.n_title;
					shareContent=json.data.n_info;
					shareUrl="http://www.lvdoya.com/H5/share_netuDetails.html?&netuId="+netuId+"&fromPage=other";
					shareImgUrl=$("#img"+netuId)[0].src;					
					
					$("#loadingToast").css("display","none");
					setTimeout(function(){myScroll.refresh();},500);
				}
				else
				{
					$("#loadingToast").css("display","none");
					jectNotice(json.msg);
				}
			},
			error : function(textStatus) 
			{
				$("#loadingToast").css("display","none");
			}
		});	
	}
	
	function inputSubmit(){
		$("#dialogInput").css("display","none");
		$("#loadingToast").css("display","block");
		
		var inputCode=$("#txt_dialogInput").val();
		if (inputCode==""){
			$("#loadingToast").css("display","none");
			return;
		}
//		$("#td_pageTitle").html(inputCode);
		$.ajax	
		({
			type : "POST",url:"http://114.55.103.71:9006/ldy/neutral/dealNeutral?callback=?&token="+token+"&neutralId="+netuId+"&code="+inputCode,data: {},dataType : "jsonp",	
			success : function(data) 
			{   
				var json = eval(data);
				if (json.code==200){	
					$("#loadingToast").css("display","none");					
					
					if (fromPage=="H5"){
						window.location="netu_messageAdd.html?token="+token+"&netuId="+netuId+"&fromPage=H5";
					} else {
						var newUrl="http://www.lvdoya.com/H5/netu_messageAdd.html?token="+token+"&netuId="+netuId;
						aif.javaOpenNewWindow(newUrl);			
					}

				}
				else
				{
					$("#loadingToast").css("display","none");
					$("#dialogInput").css("display","none");
					jectNotice(json.msg);
				}
				$("#tableBottom").css("bottom","0px");
				$("#txt_dialogInput").val("");
			},
			error : function(textStatus) 
			{
				alert("server error");
				$("#loadingToast").css("display","none");
			}
		});
	}
	
	// Iscorll
	var myScroll,  
	pullDown = $("#pullDown"),  
	pullDownLabel = $(".pullDownLabel"),  

	loadingStep = 0;//加载状态0默认，1显示加载状态，2执行加载数据，只有当为0时才能再次加载，这是防止过快拉动刷新  
	pullDown.hide();  
  
	myScroll = new IScroll("#wrapper", {  
		preventDefault:false,
		scrollbars: false,  
		mouseWheel: false,  
		interactiveScrollbars: true,  
		shrinkScrollbars: 'scale',  
		fadeScrollbars: true,  
		scrollY:true,  
		probeType: 2,  
		bindToWrapper:true  
	});  

	myScroll.on("scroll",function(){  
		if(loadingStep == 0 && !pullDown.attr("class").match('refresh|loading')){  
			if(this.y > 40){//下拉刷新操作  
				$(".pulldown-tips").hide();  
				pullDown.addClass("refresh").show();  
				pullDownLabel.text("松手刷新数据");  
				loadingStep = 1; 
				
				myScroll.refresh();  				
			}else if(this.y <= (this.maxScrollY)  && this.directionY == 1){//上拉加载更多
				if (noMoreData==false && allowLoad==true){
					loadingStep = 1;  
					$("#p_loadContent").html("正在加载");
					$("#loadingToast").css("display","block");
					pullUpAction(); 					
				} else {
					setTimeout(function(){myScroll.refresh();},1);
				}

			}  
		}  
	});  
	myScroll.on("scrollEnd",function(){  
		if(loadingStep == 1){  
			if( pullDown.attr("class").match("refresh") ){//下拉刷新操作  
				pullDown.removeClass("refresh").addClass("loading");  
				$("#p_loadContent").html("正在刷新");
				$("#loadingToast").css("display","block");
				loadingStep = 2;  
				pullDownAction();  
			}  
		}  
	});  

	function pullDownAction(){  
		setTimeout(function(){  
			pullDown.attr('class','').hide();
			loadingStep = 0;
			pageNo=1;
			noMoreData=false;
			init();
			$(".pulldown-tips").show(); 
			$("#loadingToast").css("display","none");
			$(".pulldown-tips").css("display","none");
		},500);  
		setTimeout(function(){myScroll.refresh();},1000);
	}		
	function pullUpAction(){  
		setTimeout(function(){  
			loadingStep = 0;  
			// do your something
		},500);  
		setTimeout(function(){myScroll.refresh();},100);
	}  
  
    document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);  
	// END Iscorll	
</script>