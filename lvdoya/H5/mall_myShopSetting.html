<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>myShopSetting</title>
<style>
body
{
	margin:0;
	background-color:#f0f0f2;
	font-family: sans-serif;
}

.txt
{
	width:100%;
	height:45px;
	border-radius:0px;
	border:1px solid #bbbbbb;
	color:#999;
	font-size:16px;
	padding:0px;
	-webkit-appearance: none;
}
.styleShopFace {
	width:100%;
	height:200px;
}
.td_goodsFace
{
	width:80px; text-align:center; vertical-align:middle;
}
.td_goodsFace img
{
	width:80px; height:80px; top:0px; left:0px;
}
</style>
<link rel="stylesheet" href="css/weui.css">
<script type="text/javascript" src="js/jquery-3.1.1.min.js" ></script>
<!--图片上传-->
<script type="text/javascript" src="pluginUpimg/mallShopFace.js" ></script>
<script type="text/javascript" src="pluginUpimg/lrz.all.bundle.js" ></script>
<!--END 图片上传-->
<script src="js/functionPublic.js"></script>
</head>
<body onload="getOwnStoreByUserid();">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:45px; background-color:#1AAD19; position:fixed; top:0px;">
  <tr>
    <td style="width:40px; text-align:center; vertical-align:middle;" onclick="go_back(1);"><img src="ico/ico_back.png" style="max-width:26px;" /></td>
    <td style="text-align:center; font-size:16px; color:#fff;">店铺设置</td>
    <td style="width:40px; vertical-align:middle; text-align:center; font-size:14px; color:#fff;" onclick="saveStore();"><img src="ico/ico_save_fff.png" style="max-height:20px;" /><br />保存</td>
  </tr>
</table>
<div style="width:100%; height:45px;"></div>
<div style="margin-left:10px; margin-right:10px; font-size:14px; color:#333; line-height:45px;">店铺名称</div>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td style="width:10px;">&nbsp;</td>
    <td>
		<input id="txt_shopName" class="txt" maxlength="20" type="text" onfocus="if(this.value==defaultValue) {this.value=''; this.style.color='#000';}" onblur="if(!value) {value=defaultValue; this.style.color='#999';};" value="2-20个字" />
    </td>
    <td style="width:10px;">&nbsp;</td>
  </tr>
</table>
<div style="margin-left:10px; margin-right:10px; font-size:14px; color:#333; line-height:45px;">广告词</div>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
    <td style="width:10px;">&nbsp;</td>
    <td>
    	<input id="txt_shopPs" class="txt" maxlength="20" type="text" onfocus="if(this.value==defaultValue) {this.value=''; this.style.color='#000';}" onblur="if(!value) {value=defaultValue; this.style.color='#999';};" value="2-20个字" />
    </td>
    <td style="width:10px;">&nbsp;</td>
  </tr>
</table>

<div id="div_imgMallShopFace" class="div_imgMallShopFace" style="margin:20px 10px 0px 10px; background-color:#fff; border:1px solid #bbbbbb; display:none;"></div>

<div style="margin:20px 10px 0px 10px; background-color:#fff; border:1px solid #bbbbbb; position:relative;" id="div_upMallShopFace">
<table id="tb_shopFace" width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color:#fff; height:200px;">
  <tr>
    <td style="vertical-align:middle; text-align:center; color:#8a8a8a; font-size:16px;"><img src="ico/ico_camera.png" style="max-width:30px; vertical-align:middle;" /><br />上传店铺形象图<br /><font style="font-size:10px;">（建议使用相机横拍照片）</font></td>
  </tr>
</table>
</div>

<div style="margin:0px 10px 0px 10px; line-height:40px; font-size:14px;">设置推荐商品（<font id="font_recommendNum">0</font>/3）</div>
<div style="margin:0px 10px 0px 10px; line-height:20px; font-size:12px; color:#8a8a8a; position:relative;">
    推荐商品同店铺一起展示在商城首页
    <div onclick="loadGoodsList();" style="width:60px; line-height:30px; color:#fff; background-color:#2baf2b; position:absolute; bottom:0px; right:0px; text-align:center; border-radius:3px; font-size:14px;">添加</div>
</div>

<div id="div_recommendContent"></div>

<div style="width:100%; height:20px;"></div>
</body>
</html>        

<!--==================================================================================================================================================-->
<input id="hid_token" type="hidden" value="" />
<input id="hid_storeid" type="hidden" value="" />
<input id="hid_shopFace" type="hidden" value="" />
<div id="toast" style="display: none;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <i class="weui_icon_toast"></i>
        <p class="weui_toast_content">保存成功</p>
    </div>
</div>
<div class="weui_dialog_alert" id="notice" style="display:none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">提示</strong></div>
        <div id="noticeContent" class="weui_dialog_bd"></div>
        <div class="weui_dialog_ft">
            <a href="javascript:$('#notice').css('display','none');" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div id="loadingToast" class="weui_loading_toast" style="display:none;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <!-- :) -->
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p class="weui_toast_content">正在处理</p>
    </div>
</div>

<!--BEGIN actionSheetRecommend-->
<div id="actionSheet_wrapRecommend">
    <div class="weui_mask_transition" id="maskRecommend"></div>
    <div class="weui_actionsheet" id="weui_actionsheetRecommend" style="height:100%; overflow:scroll;">
		<div style="width:100%; height:40px; text-align:center; background-color:#1AAD19; color:#fff; font-size:16px; line-height:40px;"><img src="ico/ico_close_fff.png" style="float:right; margin-right:10px; max-height:30px; margin-top:5px;" onclick="hideActionSheetRecommend();" /></div>
        
        <div id="div_recommendList1"></div>      
                    
    </div>
</div>
<!--END actionSheetRecommend-->

<!--==================================================================================================================================================-->


<script>
var token=GetUrlParam("token");
var userid=GetUrlParam("userid");
var recommendIds="";
var pageNo=1;

//var tbWidth=$("#tb_shopFace").width();
//var tbHeight=parseFloat(tbWidth)/1.7;
//$("#tb_shopFace").css("height",parseFloat(tbHeight).toFixed(2)+"px");
//$("#div_imgMallShopFace").css("height",parseFloat(tbHeight).toFixed(2)+"px");

function getOwnStoreByUserid()
{
	url=window.location.href;
	saveFootprint(url);
	var token=GetUrlParam("token");
	var userid=GetUrlParam("userid");
	$("#loadingToast").css("display","block");
	$.ajax
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/store/getOwnStoreByUserid?callback=?&token="+token+"&userid="+userid,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){				
				$("#hid_storeid").val(json.data.store_id);
				$("#hid_shopFace").val(json.data.store_img);
				if (json.data.store_title!=""){
					$("#txt_shopName").css("color","#000");
					$("#txt_shopName").val(json.data.store_title);
				}		
				if (json.data.store_ps!=""){
					$("#txt_shopPs").css("color","#000");
					$("#txt_shopPs").val(json.data.store_ps);
				}
				if (json.data.store_img!=""){
					$("#div_upMallShopFace").css("display","none");
					$("#div_imgMallShopFace").css("display","block");
					$("#div_imgMallShopFace").html('<div class="imgDiv" style="position:relative;">'+json.data.store_img+'<div onclick="remove_img(this)" style=" background-color:#000; width:40px; height:40px; position:absolute; top:5px; right:5px; border-radius:50%; text-align:center; opacity:0.7;"><img src="ico/ico_del_yellow.png" style="max-height:26px; margin-top:7px;" /></div></div>');
				}
				if ($.trim(json.data.store_tuijian)!=""){
					var recommendArray=new Array();
					recommendIds=$.trim(json.data.store_tuijian)+",";//末位加逗号，保存时去除
					recommendArray=json.data.store_tuijian.split(",");
					$("#font_recommendNum").html(recommendArray.length);
					
					for(var i=0; i<recommendArray.length; i++){
						queryGoods(recommendArray[i]);
					}
				}
				$("#loadingToast").css("display","none");
			}
			else
			{
				$("#loadingToast").css("display","none");
				alert(json.code);
			}
		},
		error : function(textStatus) 
		{
		}
	});	
}

function queryGoods(goodsId)
{
	$.ajax
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/getGoodsBySpid?callback=?&spId="+goodsId,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				var result="";
				result=$("#div_recommendContent").html();
				result+="<div id='div_recommend"+goodsId+"' style='margin:10px 10px 0px 10px;'><table width='100%' border='0' cellspacing='0' cellpadding='0' bgcolor='#FFFFFF'><tr><td class='td_goodsFace'>"+json.data.coverImg+"</td><td style='position:relative;'><div style='width:100%; height:40px; line-height:46px; overflow:hidden;'><font style='font-size:16px; margin-left:10px;'>"+json.data.title+"</font></div><div style='width:100%; height:40px; line-height:40px;'><font style='color:#1AAD19; font-size:20px; margin-left:10px;'>"+parseFloat(json.data.normsJson[0].price).toFixed(2)+"</font><font style='font-size:14px;'>碳票</font></div><img src='ico/ico_del.png' onclick='removeRecommend(&apos;"+goodsId+"&apos;);' style='max-height:20px; position:absolute; top:10px; right:10px;' /></td></tr></table></div>";
				$("#div_recommendContent").html(result);
			}
			else
			{
				$("#loadingToast").css("display","none");
				alert(json.code);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});		
}

function updateStore()
{
	post_mallShopFace();//上传图片
	var token=GetUrlParam("token");
	var storeid=$("#hid_storeid").val();
	var shopName=$("#txt_shopName").val();
	var shopPs=$("#txt_shopPs").val();
	var shopFace=$("#hid_shopFace").val();
	
	recommendIds=recommendIds.substring(0,recommendIds.length-1); //去掉末位逗号
	
	if (shopPs=="2-20个字"){
		shopPs="";
	}
	
	var interFaceUrl="http://114.55.103.71:9006/ldy/store/updateStore?callback=?&token="+token+"&storeid="+storeid+"&title="+shopName+"&ps="+shopPs+"&img="+shopFace+"&tuijian="+recommendIds;
	
	$.ajax
	({
		type : "POST",url:interFaceUrl,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){	
				$("#loadingToast").css("display","none");			
				$("#toast").css("display","block");			
				setTimeout(function(){$("#toast").css("display","none"); history.go(-1);},2000);	
			}
			else
			{
				$("#loadingToast").css("display","none");
				alert(json.code);
			}
		},
		error : function(textStatus) 
		{
		}
	});	
}

function saveStore()
{
	if ($("#txt_shopName").val()=="2-20个字") {
		$("#notice").css("display","block");
		return;
	}
	$("#loadingToast").css("display","block");
	setTimeout(function(){updateStore();},500);	
}

function showRecommend() 
{
	var maskRecommend = $('#maskRecommend');
	var weuiActionsheetRecommend = $('#weui_actionsheetRecommend');
	weuiActionsheetRecommend.addClass('weui_actionsheet_toggle');
	maskRecommend.show().addClass('weui_fade_toggle').click(function() {
		hideActionSheetRecommend(weuiActionsheetRecommend, maskRecommend);
	});
	weuiActionsheetRecommend.unbind('transitionend').unbind('webkitTransitionEnd');
}

function hideActionSheetRecommend() {
	pageNo=1;
	var maskRecommend = $('#maskRecommend');
	var weuiActionsheetRecommend = $('#weui_actionsheetRecommend');

	weuiActionsheetRecommend.removeClass('weui_actionsheet_toggle');
	maskRecommend.removeClass('weui_fade_toggle');
	weuiActionsheetRecommend.on('transitionend', function() {
		maskRecommend.hide();
	}).on('webkitTransitionEnd',
		function() {
			maskRecommend.hide();
		})
}

function loadGoodsList()
{
	if ($("#font_recommendNum").html()=="3"){
		jectNotice("已添加3件，不能再添加");
		return;
	}
		
	$("#loadingToast").css("display","block");
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/getGoodsByUserid?callback=?&userId="+userid+"&status=0&pageNo="+pageNo,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){				
				var result="";
				
				if (json.data.length==0 && pageNo==1) {
					result="<div style='width:100%; text-align:center; margin-top:100px;'><img src='ico/ico_shopEmpty.png' style='max-height:100px; margin-bottom:10px;' /><br /><font style='font-size:14px; color:#8a8a8a;'>没有在售商品</font></div>";
					$("#div_recommendList"+pageNo).html(result);
					showRecommend();
				}
				if (json.data.length>0){
					for(var i=0; i<json.data.length; i++) {
						result+="<table onclick='chooseRecommend(&apos;"+json.data[i].spId+"&apos;);' width='100%' border='0' cellspacing='0' cellpadding='0' style='height:80px; margin-bottom:5px; background-color:#fff;'><tr><td id='td_goodsFace"+json.data[i].spId+"' class='td_goodsFace'>"+json.data[i].coverImg+"</td><td><div style='width:100%; height:40px; line-height:46px;'><font id='font_goodsName"+json.data[i].spId+"' style='font-size:16px; margin-left:10px;'>"+json.data[i].title+"</font></div><div style='width:100%; height:40px; line-height:40px;'><font id='font_goodsPrice"+json.data[i].spId+"' style='color:#1AAD19; font-size:20px; margin-left:10px;'>"+parseFloat(json.data[i].normsJson[0].price).toFixed(2)+"</font><font style='font-size:14px;'>碳票</font></div></td></tr></table>";
					}
					nextPageNo=parseInt(pageNo)+1;
					result+="<div id='div_recommendList"+nextPageNo+"'></div>"
					result+="<div id='div_loadMore"+pageNo+"' onclick='loadGoodsList();' style='width:100%; height:30px; line-height:30px; color:#979797; text-align:center; font-size:14px;'>点击加载更多</div>";
					$("#div_recommendList"+pageNo).html(result);
					$("#loadingToast").css("display","none");					
					if (pageNo==1){
						showRecommend();
					} else {
						$("#div_loadMore"+pageNo).css("display","none");
					}
					pageNo++;
				} else if (json.data.length==0 && pageNo>1){
					$("#loadingToast").css("display","none");
					alert("没有更多了");
				} else {
					$("#loadingToast").css("display","none");
				}
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});	
}

function chooseRecommend(goodsId)
{
	if ($("#font_recommendNum").html()=="3"){
		hideActionSheetRecommend();
		jectNotice("已添加3件，不能再添加");
		return;
	}
	
	if (recommendIds.indexOf(goodsId+",")>=0){
		hideActionSheetRecommend();
		jectNotice("该商品已被选择，请重新选择");
		return;		
	}
	
	var result="<div id='div_recommend"+goodsId+"' style='margin:10px 10px 0px 10px;'><table width='100%' border='0' cellspacing='0' cellpadding='0' bgcolor='#FFFFFF'><tr><td class='td_goodsFace'>"+$("#td_goodsFace"+goodsId).html()+"</td><td style='position:relative;'><div style='width:100%; height:40px; line-height:46px; overflow:hidden;'><font style='font-size:16px; margin-left:10px;'>"+$("#font_goodsName"+goodsId).html()+"</font></div><div style='width:100%; height:40px; line-height:40px;'><font style='color:#1AAD19; font-size:20px; margin-left:10px;'>"+$("#font_goodsPrice"+goodsId).html()+"</font><font style='font-size:14px;'>碳票</font></div><img src='ico/ico_del.png' onclick='removeRecommend(&apos;"+goodsId+"&apos;);' style='max-height:20px; position:absolute; top:10px; right:10px;' /></td></tr></table></div>";
	
	recommendIds+=goodsId+",";
	
	$("#div_recommendContent").html($("#div_recommendContent").html()+result);
	
	$("#font_recommendNum").html(parseInt($("#font_recommendNum").html())+1);
	
	hideActionSheetRecommend();	
	
	console.log(recommendIds);
}

function removeRecommend(goodsId)
{
	recommendIds=recommendIds.replace(goodsId+",","")
	$("#div_recommend"+goodsId).css("display","none");
	$("#font_recommendNum").html(parseInt($("#font_recommendNum").html())-1);
	console.log(recommendIds);
}
</script>