<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<title>mallSettle</title>
<style>
body
{
	margin:0;
	background-color:#f0f0f2;
	font-family: sans-serif; 
}
.div_address
{
	width:100%; height:100%; border-bottom:1px solid #bbbbbb;
}
.div_addressName
{
	width:100%; height:40px; line-height:46px;
}
.div_addressName img
{
	max-height:18px; margin-left:10px;
}
.div_addressDetails
{
	width:90%; line-height:24px; word-break:break-all; color:#666;
}
.txt_address
{
	width:100%;	height:45px; border-radius:0px; border:none; font-size:16px; padding:0px; -webkit-appearance:none; margin-top:5px; margin-bottom:10px;
}

.txt_password
{
	width:100%;	height:50px; border-radius:0px;	border:none; color:#000; font-size:40px; padding:0px; -webkit-appearance: none; margin-top:5px; margin-bottom:10px; text-align:center; margin-top:5px;
}
.tablePassword
{
	background-color:#fff;
}
.tablePassword td
{
	width:33%; height:50px; vertical-align:middle; text-align:center; font-size:20px; border-bottom:1px solid #f2f2f2; border-right:1px solid #f2f2f2;
}
/*BEGIN list*/
.div_shopName
{
	width:100%; border-bottom:1px solid #bbbbbb; line-height:30px;
}
.td_goodsFace
{
	height:100px; width:100px; text-align:center; vertical-align:middle;
}
.td_goodsFace img
{
	width:80px; height:80px; vertical-align:middle;
}
.div_goodsName
{
	width:100%; height:40px; line-height:40px; overflow:hidden; font-size:14px;
}
.div_goodsModel
{
	width:100%; height:30px; line-height:30px; overflow:hidden; font-size:12px; color:#8a8a8a;
}
.div_goodsPrice
{
	width:100%; height:40px; line-height:40px; overflow:hidden;
}
.div_goodsFeright
{
	width:100%; height:40px; line-height:40px; font-size:14px; border-top:1px solid #f2f2f2;
}
.div_goodsMemo
{
	width:100%; height:40px; line-height:40px; font-size:14px; border-top:1px solid #f2f2f2;
}
.txt_memo
{
	float:left; margin-left:10px; width:80%; height:40px; padding:0px; border:0px; border-bottom:1px solid #f2f2f2; font-size:16px;
}
.div_sum
{
	width:100%; height:40px; line-height:40px; border-bottom:1px solid #bbbbbb;
}
.font_sum
{
	color:#1AAD19; font-size:18px; font-weight:bold; float:right;
}
.font_goodsNum
{
	float:right; margin-right:10px; font-size:14px; color:#8a8a8a;
}
/*END list*/
</style>
</head>
<link rel="stylesheet" type="text/css" href="css/weui.css">
<script type="text/javascript" src="js/jquery-3.1.1.min.js" ></script>
<script type="text/javascript" src="js/fastclick.js"></script>
<script src="js/functionPublic.js"></script>
<script src="js/tripledes.js"></script>
<script src="js/mode-ecb.js"></script>
<body onload="init();">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:45px; background-color:#1AAD19; position:fixed; top:0px; z-index:8888;">
  <tr>
    <td style="width:40px; text-align:center; vertical-align:middle;" onclick="go_back(1);"><img src="ico/ico_back.png" style="max-width:26px;" /></td>
    <td id="td_shopName" style="text-align:center; font-size:16px; color:#fff;">结算支付</td>
    <td id="td_shopShare" style="width:40px; vertical-align:middle; text-align:center;">&nbsp;</td>
  </tr>
</table>
<div style="width:100%; height:45px;"></div>
<!--<input name="" type="text" />-->
<!--<div style="width:100%; height:3px; background-image:url(img/addressBorder.png);"></div>-->
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color:#fff;">
  <tr>
    <td style="width:50px;"><img src="ico/ico_position_g.png" style="max-height:30px; margin-left:10px;" /></td>
    <td style="vertical-align:middle; position:relative;">
    	<div id="div_addNo" style="width:90%; height:70px; line-height:70px; display:block; font-size:16px; color:#8a8a8a; vertical-align:middle;">
        	暂无收货地址，立即添加
        </div>
        <div id="div_addYes" style="width:100%; height:100%; display:none;">
        	<div style="width:100%; height:40px; line-height:46px;"><font id="font_addName" style="font-size:18px;"></font><font id="font_addMobile" style="margin-left:10px;"></font></div>
            <div style="width:90%; line-height:24px; word-break:break-all; color:#666;"><font id="font_address" style="font-size:14px;"></font></div>
        </div>
        <img src="ico/ico_more_444.png" style="position:absolute; top:25px; right:10px; max-height:20px;" />
    </td>
  </tr>
</table>
<div style="width:100%; height:3px; background-image:url(img/addressBorder.png); background-color:#fff; margin-bottom:5px;"></div>

<div id="div_settleList">
<!--<div id="div_selltListContent" style="background-color:#fff;">
    <div class="div_shopName"><font id="font_shopName" style="margin-left:10px;">PAPI的小店</font></div>
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td id="td_goodsFace" class="td_goodsFace"><img src="img/goods.jpg" /></td>
        <td>
            <div id="div_goodsName" class="div_goodsName">2017款带帽超宽T恤 型男必备 I.T.主推款 限量发售</div>
            <div id="div_goodsModel" class="div_goodsModel">黑色</div>
            <div class="div_goodsPrice">
                <font id="font_goodsPrice" style="color:#1AAD19; font-size:18px;">100.00</font><font style="font-size:12px; color:#333;">碳票</font>
                <font id="font_goodsNum" class="font_goodsNum">×3</font>
            </div>
        </td>
      </tr>
    </table>
    <div class="div_goodsFeright">
        <font style="float:left; margin-left:10px;">运费</font>
        <font id="font_freight" style="float:right; margin-right:10px;">碳票</font>
    </div>
    <div class="div_goodsMemo">
        <font style="float:left; margin-left:10px;">备注</font>
        <input id="txt_goodsMemo" type="text" class="txt_memo"/>
    </div>
    <div class="div_sum">
        <font style="font-size:12px; float:right; margin-right:10px;">碳票</font>    
        <font id="font_goodsPriceSum" class="font_sum">300.00</font>
        <font style="font-size:14px; float:right;">合计:</font>    
    </div>
</div>-->
</div>


<div style="width:100%; height:60px;"></div>
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:50px; position:fixed; bottom:0px; background-color:#fff; border-top:1px solid #ccc;">
  <tr>
    <td style="width:10px;">
    	<!--<div class="div_chooseAll" onclick="chooseAll(this);">全选</div>-->
    </td>
    <td>    	
        <div style="width:100%; height:30px; line-height:36px;">
        	<font style="font-size:12px;">合计:</font><font id="font_priceSum" style="font-size:20px; color:#1AAD19; font-weight:bold;">0.00</font><font style="font-size:12px;">碳票</font>
        </div>
        <div style="width:100%; height:20px; line-height:22px; font-size:12px; color:#333;">合计附送碳:<font id="font_ccerSum" style="font-size:14px; font-weight:bold; color:#C03;">0.00</font>吨</div>
    </td>
    <td onclick="showPasswordPanel();" style="background-color:#1AAD19; text-align:center; vertical-align:middle; width:40%; color:#fff; font-weight:bold;">提交并支付</td>  <!--id="td_Pay"-->
  </tr>
</table>
</body>
</html>
<!--BEGIN ==================================================================================================================================================-->
<input id="hid_addressId" type="hidden" value="" />
<div id="toast" style="display: none;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <i class="weui_icon_toast"></i>
        <p id="toastContent" class="weui_toast_content">保存成功</p>
    </div>
</div>
<div id="loadingToast" class="weui_loading_toast" style="display:none; z-index:999999;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p id="p_loadContent" class="weui_toast_content">正在加载</p>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogAsk" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle"></strong></div>
        <div id="dialogContent" class="weui_dialog_bd"></div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogAsk').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:shopCarDel();" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogPassword" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle">提示</strong></div>
        <div id="dialogContent" class="weui_dialog_bd">你还未设置安全密码</div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogPassword').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:go_setPassword();" class="weui_btn_dialog primary">去设置</a>
        </div>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogLessTiket" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle">碳票余额不足</strong></div>
        <div id="dialogContent" class="weui_dialog_bd">当前账户碳票余额:<font id="font_tiket" style="color:#1AAD19;"></font>碳票<br />如需支付该订单，请先充值</div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogLessTiket').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:go_recharge();" class="weui_btn_dialog primary">去充值</a>
        </div>
    </div>
</div>

<div class="weui_dialog_alert" id="notice" style="display:none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title">提示</strong></div>
        <div class="weui_dialog_bd" id="noticeContent">&nbsp;</div>
        <div class="weui_dialog_ft">
            <a href="javascript:$('#notice').css('display','none');" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>

<!--BEGIN actionSheetAddress-->
<div id="actionSheet_wrapAddress">
    <div class="weui_mask_transition" id="maskAddress"></div>
    <div class="weui_actionsheet" id="weui_actionsheetAddress" style="height:100%; overflow:scroll;">
		<div style="width:100%; height:50px;"></div>
        <div id="div_addressList"></div>
    	<table style="width:100%; position:fixed; bottom:0px; border-top:1px solid #ccc; background-color:#fff;">
        	<tr>
				<td style="width:50%;"><div onclick="hideActionSheetAddress();" style="width:80%; height:36px; line-height:36px; text-align:center; color:#333; border:1px solid #8a8a8a; border-radius:5px; margin:0 auto;">取消</div></td>
                <td style="width:50%;"><div id="div_addressAdd" style="width:80%; height:36px; line-height:36px; text-align:center; color:#fff; background-color:#1AAD19; border:1px solid #8a8a8a; border-radius:5px; margin:0 auto;">新增</div></td>
            </tr>
        </table>        
    </div>
</div>
<!--END actionSheetAddress-->

<!--BEGIN actionSheetAddressNew-->
<div id="actionSheet_wrapAddressNew">
    <div class="weui_mask_transition" id="maskAddressNew"></div>
    <div class="weui_actionsheet" id="weui_actionsheetAddressNew" style="height:100%;">
		<div style="width:100%; height:50px;"></div>
        <div style="margin:0px 10px 0px 10px;">
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td><div style="font-size:14px;">收货人姓名</div><input id="txt_addressName" class="txt_address" type="text" /></td>
              </tr>
              <tr>
                <td><div style="font-size:14px;">收货人电话</div><input id="txt_addressTel" class="txt_address" type="text"  onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"/></td>
              </tr>
              <tr>
                <td><div style="font-size:14px;">收货人详细地址</div><input id="txt_addressDetails" class="txt_address" type="text" /></td>
              </tr>
            </table>    
            <div class="weui_cells weui_cells_form">
                <div class="weui_cell weui_cell_switch">
                    <div class="weui_cell_hd weui_cell_primary">设为默认地址</div>
                    <div class="weui_cell_ft">
                        <input id="chk_defaultAddress" class="weui_switch" type="checkbox" />
                    </div>
                </div>
            </div>        
            <div id="div_notice" style="width:100%; text-align:center; font-size:14px; color:red; line-height:30px;"></div>
        </div>
        <table style="width:100%; position:fixed; bottom:0px; border-top:1px solid #ccc; background-color:#fff;">
            <tr>
                <td style="width:50%;"><div onclick="hideActionSheetAddressNew();" style="width:80%; height:36px; line-height:36px; text-align:center; color:#333; border:1px solid #8a8a8a; border-radius:5px; margin:0 auto;">取消</div></td>
                <td style="width:50%;"><div id="div_addressAdd" onclick="saveAddress();" style="width:80%; height:36px; line-height:36px; text-align:center; color:#fff; background-color:#1AAD19; border:1px solid #8a8a8a; border-radius:5px; margin:0 auto;">保存</div></td>
            </tr>
        </table>         
    </div>
</div>
<!--END actionSheetAddressNew-->

<!--BEGIN actionSheetPassword-->
<div id="actionSheet_wrapPassword" style="z-index:9999;">
    <div class="weui_mask_transition" id="maskPassword"></div>
    <div class="weui_actionsheet" id="weui_actionsheetPassword">
    <div style="width:100%; height:50px; line-height:50px; font-size:16px; color:#1AAD19; text-align:center; font-weight:bold;">订单提交成功，输入安全密码支付</div>
    <div style="width:100%; height:60px; text-align:center;"><input id="txt_password" type="password" class="txt_password" /></div>
    <table width="100%" border="0" cellspacing="0" cellpadding="0" class="tablePassword">
      <tr>
        <td onclick="typePassword(this);">1</td>
        <td onclick="typePassword(this);">2</td>
        <td onclick="typePassword(this);">3</td>
      </tr>
      <tr>
        <td onclick="typePassword(this);">4</td>
        <td onclick="typePassword(this);">5</td>
        <td onclick="typePassword(this);">6</td>
      </tr>
      <tr>
        <td onclick="typePassword(this);">7</td>
        <td onclick="typePassword(this);">8</td>
        <td onclick="typePassword(this);">9</td>
      </tr>    
      <tr>
        <td onclick="" style="font-size:10px; color:#8a8a8a;">&nbsp;</td>
        <td onclick="typePassword(this);">0</td>
        <td onclick="typePassword(this);">×</td>
      </tr>         
    </table>	       
    </div>
</div>
<!--END actionSheetPassword-->
<!--END  ==================================================================================================================================================-->  
<script>
var token=GetUrlParam("token");
var priceTotle=0;
var ccerTotle=0;  
var paramKeys="";	  //传送订单参数
var settleNum=0;  //结算商品数量
var tiketStatus=-1;
var key = CryptoJS.enc.Utf8.parse("huangkaishitemegedahaoren");  
var iv  = CryptoJS.enc.Utf8.parse("BrTc2404");  

$(function() {
	$('#div_addYes,#div_addNo').click(function() {
		var mask = $('#maskAddress');
		var weuiActionsheet = $('#weui_actionsheetAddress');
		weuiActionsheet.addClass('weui_actionsheet_toggle');
		mask.show().addClass('weui_fade_toggle').click(function() {
			hideActionSheet(weuiActionsheet, mask);
		});

		weuiActionsheet.unbind('transitionend').unbind('webkitTransitionEnd');
	});
	
	$('#div_addressAdd').click(function() {
		var maskNew = $('#maskAddressNew');
		var weuiActionsheetAddressNew = $('#weui_actionsheetAddressNew');
		weuiActionsheetAddressNew.addClass('weui_actionsheet_toggle');
		maskNew.show().addClass('weui_fade_toggle').click(function() {
			hideActionSheetAddressNew(weuiActionsheetAddressNew, maskNew);
		});
		weuiActionsheetAddressNew.unbind('transitionend').unbind('webkitTransitionEnd');
	});		
});

$(function() {    
    FastClick.attach(document.body); 		//FastClick插件，提高点击速度   
}); 

function queryTiket()
{
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/order/orderCanPay?callback=?&token="+token+"&money="+$("#font_priceSum").html(),data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				if (json.data.status==0) {
					$("#font_tiket").html(json.data.account);
					$("#dialogLessTiket").css("display","block");
					$("#loadingToast").css("display","none");
					tiketStatus=0;
				} else {
					tiketStatus=1;
					setTimeout(function (){queryPassword();},500);
				}
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});	
}

function showPasswordPanel() 
{
	$("#loadingToast").css("display","block");
	queryTiket();
}

function queryPassword()
{
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/user/checkSecPwdToJSON?callback=?&token="+token,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				if (json.data==1){ //已设置
					var maskPassword = $('#maskPassword');
					var weuiActionsheetPassword = $('#weui_actionsheetPassword');
					weuiActionsheetPassword.addClass('weui_actionsheet_toggle');
					maskPassword.show().addClass('weui_fade_toggle').click(function() {
						hideActionSheetPassword(weuiActionsheetPassword, maskPassword);
					});
					weuiActionsheetPassword.unbind('transitionend').unbind('webkitTransitionEnd');		
					$("#loadingToast").css("display","none");	
				} else {
					$("#dialogPassword").css("display","block");
				}					
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});	
}

function go_setPassword()
{
	aif.javaGoSetPassword();
}

function go_recharge()
{
	aif.javaGoRecharge();
}

function hideActionSheetAddress() 
{
	var mask = $('#maskAddress');
	var weuiActionsheet = $('#weui_actionsheetAddress');
		
	weuiActionsheet.removeClass('weui_actionsheet_toggle');
	mask.removeClass('weui_fade_toggle');
	weuiActionsheet.on('transitionend', function() {
		mask.hide();
	}).on('webkitTransitionEnd',
		function() {
			mask.hide();
		})
}

function hideActionSheetAddressNew() 
{
	var maskNew = $('#maskAddressNew');
	var weuiActionsheetAddressNew = $('#weui_actionsheetAddressNew');
		
	weuiActionsheetAddressNew.removeClass('weui_actionsheet_toggle');
	maskNew.removeClass('weui_fade_toggle');
	weuiActionsheetAddressNew.on('transitionend', function() {
		maskNew.hide();
	}).on('webkitTransitionEnd',
		function() {
			maskNew.hide();
		})
}

function hideActionSheetPassword() {
	$("#loadingToast").css("display","none");
	var maskPassword = $('#maskPassword');
	var weuiActionsheetPassword = $('#weui_actionsheetPassword');

	weuiActionsheetPassword.removeClass('weui_actionsheet_toggle');
	maskPassword.removeClass('weui_fade_toggle');
	weuiActionsheetPassword.on('transitionend', function() {
		maskPassword.hide();
	}).on('webkitTransitionEnd',
		function() {
			maskPassword.hide();
		})
	createOrder();
}

function init()
{
	url=window.location.href;
	saveFootprint(url);
	$("#loadingToast").css("display","block");
	loadDefaultAddress();
	loadSettleList();
	loadAddress();		
}

function loadSettleList()
{
	var goodsIds=GetUrlParam("goodsIds");
	var result="";
	
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/ubc/getBuyCarSpsToJSON?callback=?&token="+token,data: {},dataType : "jsonp",	
		success : function(data) 
		{   
			var json = eval(data); 	
			var result="";
			if (json.code==200){
				for(var i=0;i<json.data.length;i++){
					if (goodsIds.indexOf(json.data[i].spId)>=0) {
						
						price=parseFloat(json.data[i].price).toFixed(2);
						freight=parseFloat(json.data[i].freight).toFixed(2);
						priceSum=(parseFloat(json.data[i].price*json.data[i].sl)+parseFloat(json.data[i].freight*json.data[i].sl)).toFixed(2);
						ccerSum=parseFloat(json.data[i].zsccer*json.data[i].sl).toFixed(2);
						goodsId=json.data[i].spId;
						priceTotle=parseFloat(priceTotle)+parseFloat(priceSum);
						ccerTotle=parseFloat(ccerTotle)+parseFloat(ccerSum);
						
						result+="<div id='div_selltListContent' style='background-color:#fff; margin-bottom:5px;'><div class='div_shopName'><font id='font_shopName' style='margin-left:10px;'>"+json.data[i].storeName+"</font></div><table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td id='td_goodsFace' class='td_goodsFace'>"+json.data[i].sp_img+"</td><td><div id='div_goodsName' class='div_goodsName'>"+json.data[i].title+"</div><div id='div_goodsModel"+settleNum+"' class='div_goodsModel'>"+json.data[i].gg+"</div><div class='div_goodsPrice'><font id='font_goodsPrice' style='color:#1AAD19; font-size:18px;'>"+price+"</font><font style='font-size:12px; color:#333;'>碳票</font><font id='font_goodsNum' class='font_goodsNum'>×"+json.data[i].sl+"</font></div></td></tr></table><div class='div_goodsFeright'><font style='float:left; margin-left:10px;'>运费</font><font id='font_freight' style='float:right; margin-right:10px;'>"+freight+"碳票</font></div><div class='div_goodsMemo'><font style='float:left; margin-left:10px;'>备注</font><input id='txt_goodsMemo"+settleNum+"' type='text' class='txt_memo' /></div><div class='div_sum'><font style='font-size:12px; float:right; margin-right:10px;'>碳票</font><font id='font_goodsPriceSum' class='font_sum'>"+priceSum+"</font><font style='font-size:14px; float:right;'>合计:</font></div></div><input id='hid_goodsId"+settleNum+"' type='hidden' value='"+json.data[i].spId+"' />";
						
						settleNum++;
					}
				}				
				$("#div_settleList").html(result);
				$("#font_priceSum").html(priceTotle.toFixed(2));
				$("#font_ccerSum").html(ccerTotle.toFixed(2));				
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});		
}

function loadDefaultAddress()
{
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/ua/getDefaultAddrsToJSON?callback=?&token="+token,data: {},dataType : "jsonp",	//默认收货地址
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				if (json.data.length!=0){
					$("#div_addNo").css("display","none");
					$("#font_addName").html(json.data.pname);
					$("#font_addMobile").html(json.data.tel);
					$("#font_address").html(json.data.diqu+json.data.jiedao+json.data.addr);
					$("#div_addYes").css("display","block");
					$("#hid_addressId").val(json.data.addrId);
				} else {
					$("#div_addYes").css("display","none");
					$("#div_addNo").css("display","block");
				}
				$("#loadingToast").css("display","none");
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});		
}

function loadAddress()
{
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/ua/getAddrsToJSON?callback=?&token="+token,data: {},dataType : "jsonp",	//所有收货地址预制入弹出层
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				var result="";
				for (var i=0; i<json.data.length; i++) {
					if (i==0){
						result+="<div id='div_address"+json.data[i].addrId+"' class='div_address' onclick='chooseAddress(&apos;"+json.data[i].addrId+"&apos;);'><div class='div_addressName'><font id='font_addressName"+json.data[i].addrId+"' style='font-size:18px; margin-left:10px;'>"+json.data[i].pname+"</font><font id='font_addressMobile"+json.data[i].addrId+"' style='margin-left:10px;'></font>"+json.data[i].tel+"<img src='ico/ico_default_g.png' /></div><div class='div_addressDetails'><font id='font_address"+json.data[i].addrId+"' style='font-size:14px; margin-left:10px;'>"+json.data[i].diqu+json.data[i].jiedao+json.data[i].addr+"</font></div></div>";
					} else {
						result+="<div id='div_address"+json.data[i].addrId+"' class='div_address' onclick='chooseAddress(&apos;"+json.data[i].addrId+"&apos;);'><div class='div_addressName'><font id='font_addressName"+json.data[i].addrId+"' style='font-size:18px; margin-left:10px;'>"+json.data[i].pname+"</font><font id='font_addressMobile"+json.data[i].addrId+"' style='margin-left:10px;'></font>"+json.data[i].tel+"</div><div class='div_addressDetails'><font id='font_address"+json.data[i].addrId+"' style='font-size:14px; margin-left:10px;'>"+json.data[i].diqu+json.data[i].jiedao+json.data[i].addr+"</font></div></div>";					
					}
				}
				$("#div_addressList").html(result);
				$("#loadingToast").css("display","none");
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});	
}

function chooseAddress(addressId)
{
	$("#hid_addressId").val(addressId);
	$("#font_addName").html($("#font_addressName"+addressId).html());
	$("#font_addMobile").html($("#font_addressMobile"+addressId).html());
	$("#font_address").html($("#font_address"+addressId).html());	
	
	$("#div_addYes").css("display","block");
	$("#div_addNo").css("display","none");
	hideActionSheetAddress();
}

function addSaveAsk()
{
	$("#dialogContent").html("是否确定新增该收货地址");
	$("#dialogConfirm").attr("onclick","saveAddress();");
	$("#dialogAsk").css("display","block");
}

function saveAddress()
{
	if ($("#txt_addressName").val()==''){
		$("#div_notice").html("请输入收货人姓名");
		return;
	} else if ($("#txt_addressTel").val()=='') {
		$("#div_notice").html("请输入收货人电话");
		return;		
	} else if ($("#txt_addressDetails").val()=='') {
		$("#div_notice").html("请输入收货人详细地址");
		return;		
	}
	
	addrName=$("#txt_addressName").val();
	addrTel=$("#txt_addressTel").val();
	addrDetails=$("#txt_addressDetails").val();
	if ($("#chk_defaultAddress").is(":checked")==true){
		addrStatus=0;
	} else {
		addrStatus=1;
	}

	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/ua/setAddrToJSON?callback=?&token="+token+"&pname="+addrName+"&tel="+addrTel+"&addr="+addrDetails+"&status="+addrStatus+"&diqu=.&jiedao=.",data: {},dataType : "jsonp",	//所有收货地址预制入弹出层
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){				
				$("#loadingToast").css("display","none");
				$("#toastContent").html("保存成功");
				$("#toast").css("display","block");				
				loadAddress();
				
				$("#txt_addressName").html("");
				$("#txt_addressTel").html("");
				$("#txt_addressDetails").html("");
				$("#div_notice").html("");
					
				setTimeout(function(){
					$("#toast").css("display","none");
					hideActionSheetAddressNew();
					},1000);
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});	
}

function createOrder()
{
	paramKeys="";
	for(var i=0; i<settleNum; i++)
	{
		paramKeys+=$("#hid_goodsId"+i).val()+":"+$("#div_goodsModel"+i).html()+":"+$("#txt_goodsMemo"+i).val()+" ,";
	}
	
	addrId=$("#hid_addressId").val();
	
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/ubc/saveToOrder?callback=?&token="+token+"&keys="+paramKeys+"&addrId="+addrId,data: {},dataType : "jsonp",	//生成订单
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){				
				//window.location=window.location;
			}
			else
			{
				$("#loadingToast").css("display","none");
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});	
}

function typePassword(obj)
{
	if ($(obj).html()!="×"){
		typeNumber=$(obj).html();
		typed=$("#txt_password").val();
		$("#txt_password").val(typed+typeNumber);
		if ($("#txt_password").val().length==6){
			pay();
		}
	} else {
		typeLength=$("#txt_password").val().length;
		typeed=$("#txt_password").val();
		$("#txt_password").val(typed.substring(0,typeLength-1));
	}
}

function pay()
{
	$("#loadingToast").css("display","block");
	
	paramKeys="";
	for(var i=0; i<settleNum; i++)
	{
		paramKeys+=$("#hid_goodsId"+i).val()+":"+$("#div_goodsModel"+i).html()+":"+$("#txt_goodsMemo"+i).val()+" ,";
	}
	
	addrId=$("#hid_addressId").val();
	pwd=$("#txt_password").val();
	pwd=Encrypt(pwd)+"";
	
	//必须对+和&进行转义替换，否则服务端接收后会变成空格
    pwd = pwd.replace(/\+/g,"%2B");
    pwd = pwd.replace(/\&/g,"%26"); 
	//END //必须对+和&进行转义替换，否则服务端接收后会变成空格	
		
	$.ajax	
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/ubc/payMoneyToJSON?callback=?&token="+token+"&keys="+paramKeys+"&addrId="+addrId+"&pwd="+pwd,data: {},dataType : "jsonp",	//支付
		success : function(data) 
		{   

			var json = eval(data); 	
			if (json.code==200){
				//alert(json.msg);
				setTimeout(function(){
					$("#loadingToast").css("display","none");
					window.location="mall_paySuccess.html?token="+token;
				},1000);
			}
			else
			{
				$("#loadingToast").css("display","none");
				//window.location="mall_payFaile.html?token="+token;
				jectNotice(json.msg);
			}
		},
		error : function(textStatus) 
		{
			$("#loadingToast").css("display","none");
		}
	});		
}


function Encrypt(word){  
	srcs = CryptoJS.enc.Utf8.parse(word);
	var encrypted = CryptoJS.TripleDES.encrypt(srcs, key, {iv:iv, mode:CryptoJS.mode.CBC,padding: CryptoJS.pad.Pkcs7});
	return encrypted;
	
}  
</script>