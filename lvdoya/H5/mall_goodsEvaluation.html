<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>myShopAdd</title>
<style>
body
{
	margin:0;
	background-color:#f0f0f2;
	font-family: sans-serif;
}
.ft_div{
	float:left;
	color:#999;
	font-size:14px;
	margin-left:10px;
	margin-right:20px;
	text-align:center;
}
.td_spLogo{float:left; max-width:60px; margin-right:20px;}
.td_spLogo img {
	margin:5px 20px 5px 10px;	width:40px;	height:40px; vertical-align:middle; float:left;}
.target-demo { display: inline-block; vertical-align: middle; float:left;}
.target-demo img {
	margin:5px 10px 5px 0px;width:30px;	height:30px; vertical-align:middle; float:left;}
.hint { color:#999; font-size:14px; text-align: center; vertical-align: middle; float:left;}
.txt
{
	width:100%;
	height:45px;
	border-radius:0px;
	border:none;
	color:#999;
	font-size:16px;
	padding:0px;
	-webkit-appearance: none;
}
#xm_setp{width:100%; height:100%; background:#fff; z-index:9000; top:0px; left:100%; display:none; overflow:scroll; position:fixed;}
.comment {
	font-size: 30px;
	color: #6C3;
	}
	.comment li {
		float: left; margin-right:10px;
	}
	ul {
		list-style: none;
	}
	.imgDiv{display:inline-block; position: relative;margin:1px 5px 1px 5px;}
	.imgDiv span{background: url("pluginUpimg/images/close.png"); display:block; width:16px; height:16px; background-size:100%; top:-5px; right:-5px; position:absolute;}
	.inputBox{width:35px; height:40px; text-align: center; position:relative; overflow: hidden;}
	.inputBox input{position:absolute; width:35px; height:40px; top:0; left:0;}
  
        #clipArea {
            height: 80vh;
        }
        #file,
        #clipBtn {   
            display:block;
            text-align: center;
        }
</style>
<link rel="stylesheet" href="css/weui.css">

<script type="text/javascript" src="js/jquery-3.1.1.min.js" ></script>
<!--图片上传-->
<script type="text/javascript" src="pluginUpClipimg/mallEvaluation.js"></script>
<script type="text/javascript" src="pluginUpClipimg/lrz.all.bundle.js" ></script>
<script src="pluginUpClipimg/iscroll-zoom.js"></script>
<script src="pluginUpClipimg/hammer.min.js"></script>
<script src="pluginUpClipimg/PhotoClip.js"></script>
<link rel="stylesheet" type="text/css" href="pluginUpClipimg/progress.css">
<!--END 图片上传-->
<script type="text/javascript" src="pluginStar/jquery.raty.min.js"></script>
<script src="js/functionPublic.js"></script>
</head>

<body onload="loadGoods();">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:45px; background-color:#1AAD19; position:fixed; top:0px; z-index:8888;">
  <tr>
    <td style="width:40px; text-align:center; vertical-align:middle;" onclick="go_back(1);"><img src="ico/ico_back.png" style="max-width:26px;" /></td>
    <td style="text-align:center; vertical-align:middle;font-size:16px; color:#fff;">发表评价</td>
    <td style="width:40px; vertical-align:middle; text-align:center; font-size:14px; color:#fff;" onclick="saveEvaluation();">发布</td>
  </tr>
</table>
<div style="width:100%; height:45px;"></div>
<div style="background-color:#fff;">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color:#fff; border-top:1px solid #bbbbbb; border-bottom:1px solid #bbbbbb;">
  <tr>
    <td style="width:10px;">&nbsp;</td>
    <td style="width:100%; height:50px; line-height:50px; background-color:#fff; font-size:14px; color:#333; border-bottom:1px solid #f2f2f2;" id="td_spLogo" >
    <div class="td_spLogo"></div>
    <div id='function-demo1' class='target-demo'></div>
     <div id="function-hint" class="hint"></div>
    </td>
    <td style="width:10px;">&nbsp;</td>
  </tr>
</table>
<div style="border-top:1px solid #bbbbbb; border-bottom:1px solid #bbbbbb; margin-bottom:10px;">
	<textarea id="txt_detailPs" class="txt" rows="30" style="color:#333; height:100px; font-size:14px; line-height:14px; overflow:scroll; overflow-y:hidden; overflow-x:hidden;" onfocus="window.activeobj=this;this.clock=setInterval(function(){activeobj.style.height=activeobj.scrollHeight+'px';},300);" onblur="clearInterval(this.clock);"></textarea>
</div>
<div id="div_imgMallGoodsDetails" class="div_imgMallGoodsDetails" style="margin-left:10px; margin-right:10px;"></div>
<div style="width:100%; height:45px; margin-bottom:30px;">
	<div style="line-height:45px; float:right; margin-right:10px; font-size:16px; color:#333;" id="tb_upMallGoodsDetails">添加图片<font id="font_imgNo">0</font>/4）</div>
    <img src="ico/ico_camera_green.png" style="float:right; margin-right:5px; max-height:21px; margin-top:12px;" />
</div>
<!--截图框-->
<div id="clip" style="position:absolute;width:100%;height:100%;top:0px; left:0px;display:none; z-index:999;">
    <div id="clipArea"></div>
    <button id="clipBtn" style="width:80%; height:40px; border:1px solid #cccccc; background-color:#1AAD19; color:#fff; font-size:16px; margin:0 auto; margin-top:5px; border:none; border-radius:3px;">确定</button>
</div>
<!--截图框-->
<div class="weui_cells weui_cells_form">
<div class="weui_cell">
    <div class="weui_cell_hd weui_cell_primary">匿名发表</div>
    <div class="weui_cell_ft">
        <input class="weui_switch" type="checkbox" id="beAnonymity"/>
    </div>
</div>
</div>
</div>

<div style="background-color:#fff; margin-top:10px;">
<div style="width:100%; height:50px; line-height:50px; background-color:#fff; font-size:14px; color:#333; border-bottom:1px solid #f2f2f2;">
<img src="ico/ico_shop_g.png" style=" max-width:30px; vertical-align:middle; margin-left:10px;"/><font style="margin-left:10px; font-size:16px;">店铺评分</font>
<div style="width:100%; background-color:#fff; height:100px;">
    <font class="ft_div">物流服务</font><div id='function-demo2' class='target-demo'></div><div id="function-hint2" class="hint"></div>
    <font class="ft_div">服务态度</font><div id='function-demo3' class='target-demo'></div><div id="function-hint3" class="hint"></div>
</div>
</div>
</div>
</body>
</html>
<!--==================================================================================================================================================-->
<input id="hid_goodsDetails" type="hidden" value="" />

<div id="toast" style="display: none;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <i class="weui_icon_toast"></i>
        <p class="weui_toast_content">保存成功</p>
    </div>
</div>


<div id="loadingToast" class="weui_loading_toast" style="display:none;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <!-- :) -->
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p class="weui_toast_content">正在处理</p>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogAsk" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle"></strong></div>
        <div id="dialogContent" class="weui_dialog_bd"></div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogAsk').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:saveGoodsClick();" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>
<!--==================================================================================================================================================-->
<script>
var token=GetUrlParam("token");
var spId=GetUrlParam("spId");
var orderId=GetUrlParam("orderId");
var integral_sp=5;
var storeid="";
var store_integ1=5;
var store_integ2=5;
function loadGoods()
{
	url=window.location.href;
	saveFootprint(url);
	$.ajax	//加载商品
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/getGoodsBySpid?callback=?&spId="+spId,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				$(".td_spLogo").html(json.data.coverImg);	
				 storeid=json.data.userStoreid;
			}		
		},
		error : function(textStatus) 		
		{
	
		}
	});	
}

function saveEvaluation()
{
	
	$("#loadingToast").css("display","block");
	setTimeout(function(){saveGoods();},500);
}

 //截图
var pc = new PhotoClip('#clipArea', {
size: 260,
outputSize: 640,
//adaptive: ['60%', '80%'],
file: '#file',
view: '#view',
ok: '#clipBtn',

loadStart: function() {
	console.log('开始读取照片');
},
loadComplete: function() {
	console.log('照片读取完成');
},
done: function(dataURL) {
		
		var imgdiv = $(config['img_tpl']);           
	   
		var img = imgdiv.children('img');
		img.attr("src",dataURL);              
		var filename = get_randfile();
		imgdata[filename] = {
			'filename':filename,
			'content':dataURL,
			'filelen':dataURL.length
		}
		img.attr('key', filename);
	   
		 $(".div_imgMallGoodsDetails").append(imgdiv);
		 $("#font_imgNo").html(parseInt($("#font_imgNo").html())+1);	
		 $("#clip").hide();
},
fail: function(msg) {
	alert(msg);
}
});
	
function saveGoods()
{
	post_mallGoodsDetails();//上传详情图片
	
	var token=GetUrlParam("token");
	var detailPs=$("#txt_detailPs").val();
	var detailImgs=$("#hid_goodsDetails").val();
	var beAnonymity=0;
	if($("#beAnonymity").is(':checked')){
		beAnonymity=1;
	}else{
		beAnonymity=0;
	}
	var interFaceUrl="http://114.55.103.71:9006/ldy/goods/sendGoodsEvaluation?callback=?&token="+token+"&orderId="+orderId+"&spId="+spId+"&ps="+detailPs+"&imgs="+detailImgs+"&integral="+integral_sp+"&beAnonymity="+beAnonymity;

	$.ajax
	({
		type : "POST",url:interFaceUrl,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){	
				setStoreIntegral();
			}
			else
			{
				alert(json.msg);
			}
		},
		error : function(textStatus) 
		{
		}
	});		
}

function setStoreIntegral(){
	var interFaceUrl="http://114.55.103.71:9006/ldy/store/setStoreIntegral?callback=?&token="+token+"&storeId="+storeid+"&integ1="+store_integ1+"&integ2="+store_integ2;
	$.ajax
	({
		type : "POST",url:interFaceUrl,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){	
				$("#loadingToast").css("display","none");
				go_back(1);
				//window.location="mall_buyOrder.html?token="+token+"&goto=4";
				//jectNotice(json.msg);
			}
			else
			{
				alert(json.msg);
			}
		},
		error : function(textStatus) 
		{
		}
	});		
}

function clearNoNum(obj){  
	obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符   
	obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的   
	obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");  
	obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数   
	if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额  
		obj.value= parseFloat(obj.value);  
	}  
}
$(function() {
	$.fn.raty.defaults.path = 'pluginStar/img';
	  
	$('#function-demo1').raty({
	  number: 5,//多少个星星设置
	  score: 5,//初始值是设置值
	  targetType: 'hint',//类型选择，number是数字值，hint，是设置的数组值
	  hints     : ['非常差','差','一般','好','非常好'],
	  starOff   : 'star-off.png',
	  starOn    : 'star-on.png',
	  cancel    : false,
	  target    : '#function-hint',
	  targetKeep: false,
	  targetKeep: true,
	  targetText: '请选择评分',
	  precision : false,//是否包含小数
	  width		: '230px',
	  click: function(score, evt) {
		  integral_sp=score;
		//alert('ID: ' + $(this).attr('id') + "\nscore: " + score);
	  }
	});   
	$('#function-demo2').raty({
	  number: 5,//多少个星星设置
	  score: 5,//初始值是设置值
	  targetType: 'hint',//类型选择，number是数字值，hint，是设置的数组值
	  hints     : ['非常差','差','一般','好','非常好'],
	  starOff   : 'star-off.png',
	  starOn    : 'star-on.png',
	  cancel    : false,
	  target    : '#function-hint2',
	  targetKeep: false,
	  targetKeep: true,
	  targetText: '请选择评分',
	  precision : false,//是否包含小数
	  width		: '230px',
	  click: function(score, evt) {
		  store_integ1=score;
		//alert('ID: ' + $(this).attr('id') + "\nscore: " + score);
	  }
	});   
	$('#function-demo3').raty({
	  number: 5,//多少个星星设置
	  score: 5,//初始值是设置值
	  targetType: 'hint',//类型选择，number是数字值，hint，是设置的数组值
	  hints     : ['非常差','差','一般','好','非常好'],
	  starOff   : 'star-off.png',
	  starOn    : 'star-on.png',
	  cancel    : false,
	  target    : '#function-hint3',
	  targetKeep: false,
	  targetKeep: true,
	  targetText: '请选择评分',
	  precision : false,//是否包含小数
	  width		: '230px',
	  click: function(score, evt) {
		  store_integ2=score;
		//alert('ID: ' + $(this).attr('id') + "\nscore: " + score);
	  }
	});   
	$('#function-demo1').css("float","left");
	$('#function-demo2').css("float","left");
	$('#function-demo3').css("float","left");
 }); 

</script>