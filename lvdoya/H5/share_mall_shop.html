<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width,height=device-height,inital-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<title></title>
<style>
body
{
	margin:0;
	background-color:#f0f0f2;
	font-family: sans-serif;
	overflow: hidden; /* this is important to prevent the whole page to bounce FOR iScorll */  
}
.td_userLogo img
{
	width:40px;
	height:40px;
	border-radius:50%;
	vertical-align:middle;
}
.div_shopFace img
{
	width:100%;
	height:200px;
}
.td_load
{
	width:50%;
}
.td_load img
{
	position:absolute;
	overflow:hidden;
}
.div_goodsListImg
{
	position:relative;
}
.div_goodsListImg img
{
	vertical-align:middle;
}
.td_goodsList
{
	background-color:#036;
}
.div_saleAmount
{
	background-color:#000; opacity:0.8; line-height:14px; font-size:10px; position:absolute; top:5px; right:5px; color:#fff; border-radius:3px; padding:2px;
}
/*iScorll*/

#wrapper {  
    position: absolute;  
    z-index: 1;  
    top: 45px;  
    bottom: 0px;  
    left: 0;  
    width: 100%;  
    background: #f0f0f2;  
    /*overflow: hidden; */ 
}  
  
#scroller {  
    position: absolute;  
    z-index: 1;  
    -webkit-tap-highlight-color: rgba(0,0,0,0);  
    width: 100%;  
    -webkit-transform: translateZ(0);  
    -moz-transform: translateZ(0);  
    -ms-transform: translateZ(0);  
    -o-transform: translateZ(0);  
    transform: translateZ(0);  
    -webkit-touch-callout: none;  
    -webkit-user-select: none;  
    -moz-user-select: none;  
    -ms-user-select: none;  
    user-select: none;  
    -webkit-text-size-adjust: none;  
    -moz-text-size-adjust: none;  
    -ms-text-size-adjust: none;  
    -o-text-size-adjust: none;  
    text-size-adjust: none;  
}  
  
#pullDown,#pullUp,.pulldown-tips{  
    height:40px;  
    line-height:40px;  
    text-align:center; 
	background-color:#fff; 
	color:#979797;
	font-size:12px;
}  
.pulldown-tips{  
	position:absolute;  
	top:-40px;  
	left:0;  
	width:100%;  
} 
</style>
<link rel="stylesheet" type="text/css" href="css/weui.css">
<script type="text/javascript" src="js/jquery-3.1.1.min.js" ></script>
<script type="text/javascript" src="js/iscroll-probe.js"></script>
<script src="js/functionPublic.js"></script>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<body onload="init();">
<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:45px; background-color:#1AAD19; position:fixed; top:0px; z-index:8888;">
  <tr>
    <td style="width:40px; text-align:center; vertical-align:middle;" onclick="go_back(1);"><img src="ico/ico_back.png" style="max-width:26px;" /></td>
    <td id="td_shopName" style="text-align:center; font-size:16px; color:#fff;">&nbsp;</td>
    <td id="td_shopShare" style="width:40px; vertical-align:middle; text-align:center;" onclick="share();">&nbsp;</td>
  </tr>
</table>
<div id="wrapper"> 
<div id="scroller">
<div id="pullDown" class=""><div class="pullDownLabel"></div></div>
<div class="pulldown-tips">下拉刷新</div>

<div style="width:100%; height:200px; position:relative;">
	<!--<div id="div_care" style="width:60px; height:26px; line-height:26px; color:#e36c39; background-color:#fff; border-radius:5px; position:absolute; top:10px; right:10px; font-size:12px; text-align:center; border:1px solid #e36c39; display:none;">关注</div>-->
	<div id="div_shopFace" class="div_shopFace" style="width:100%; height:200px"></div>
    <div id="div_shopPsFather" style="position:absolute; bottom:0px; width:100%; height:36px; line-height:36px; text-align:center; font-size:14px; color:#fff; display:none;">
    	<div style="width:100%; height:36px; background-color:#000; opacity:0.7;"></div>
        <div id="div_shopPs" style="position:absolute; bottom:0px; width:100%; height:36px; line-height:36px; text-align:center; font-size:14px; color:#fff;"></div>
    </div>
</div>
<div style="width:100%; height:40px; background-color:#fff; margin-top:5px; margin-bottom:5px; font-size:14px;">
	<div style="line-height:40px; float:left; margin-left:10px;">积分:</div>
    <div id="div_shopScore" style="line-height:40px; font-weight:bold; color:red; float:left;">&nbsp;</div>
    
    <div style="line-height:40px; float:right; margin-right:10px;">吨</div>
    <div id="div_shopCcer" style="line-height:40px; float:right; color:#F90; font-weight:bold;">&nbsp;</div>
    <div style="line-height:40px; float:right;">附送碳总量:</div>
</div>
<!--<table width="100%" border="0" cellspacing="0" cellpadding="0" style="height:50px; background-color:#fff;">
  <tr>
    <td style="width:10px;">&nbsp;</td>
    <td style="width:40px; text-align:left; font-size:14px; color:#666;">店主:</td>
    <td id="td_userLogo" style="width:50px; text-align:left; vertical-align:middle;" class="td_userLogo">&nbsp;</td>
    <td id="td_userNickname" style="font-size:16px;">&nbsp;</td>
    <td>&nbsp;</td>
  </tr>
</table>-->


<!--<div class="div_goodsListFather">
	<div style="float:left; width:49.5%;">
        <div class='div_goodsListImg'>
            <img class='img_goodsFace' src='http://www.lvdoya.com/app/imgGoods/1494574529860.jpeg'/>
            <div class='div_saleAmount'>已销20</div>
        </div>
        <div style="border:1px solid #bbbbbb; background-color:#fff; border-top:none;">
            <div style='line-height:20px; font-size:14px; margin-left:5px;'>AAAAA</div>
            <div style='line-height:20px; color:#1AAD19; font-size:18px; font-weight:bold; margin-left:5px;'>33333<font style='font-size:14px;'>碳票</font></div>
            <div style='line-height:20px; font-size:12px; margin-left:5px;'>附送碳:222吨</div>
        </div>
    </div>
    <div style='float:right; width:49.5%;'>
        <div class='div_goodsListImg'>
            <img class='img_goodsFace' src='http://www.lvdoya.com/app/imgGoods/1494574529860.jpeg'/>
        </div>
        <div style="border:1px solid #bbbbbb; background-color:#fff; border-top:none;">
            <div style='line-height:20px; font-size:14px; margin-left:5px;'>BBBBB</div>
            <div style='line-height:20px; color:#1AAD19; font-size:18px; font-weight:bold; margin-left:5px;'>33333<font style='font-size:14px;'>碳票</font></div>
            <div style='line-height:20px; font-size:12px; margin-left:5px;'>附送碳:222吨</div>
        </div>
    </div>
</div>
<div class="div_goodsListFather">
	<div style="float:left; width:49.5%;">
        <div class='div_goodsListImg'>
            <img class='img_goodsFace' src='http://www.lvdoya.com/app/imgGoods/1494574529860.jpeg'/>
        </div>
        <div style="border:1px solid #bbbbbb; background-color:#fff; border-top:none;">
            <div style='line-height:20px; font-size:14px; margin-left:5px;'>AAAAA</div>
            <div style='line-height:20px; color:#1AAD19; font-size:18px; font-weight:bold; margin-left:5px;'>33333<font style='font-size:14px;'>碳票</font></div>
            <div style='line-height:20px; font-size:12px; margin-left:5px;'>附送碳:222吨</div>
        </div>
    </div>
    <div style='float:right; width:49.5%;'></div>
</div>-->
<div id="div_shopGoods1" style="background-color:#fff;"></div>
<!--<div id="pullUp" class=""><div class="pullUpLabel">加载更多</div></div>-->
</div><!--scroller-->
</div><!--wrapper-->
</body>
</html>
<!--==================================================================================================================================================-->
<input id="hid_pageNo" type="hidden" value="1" />
<div id="loadingToast" class="weui_loading_toast" style="display:none; z-index:999999;">
    <div class="weui_mask_transparent"></div>
    <div class="weui_toast">
        <div class="weui_loading">
            <div class="weui_loading_leaf weui_loading_leaf_0"></div>
            <div class="weui_loading_leaf weui_loading_leaf_1"></div>
            <div class="weui_loading_leaf weui_loading_leaf_2"></div>
            <div class="weui_loading_leaf weui_loading_leaf_3"></div>
            <div class="weui_loading_leaf weui_loading_leaf_4"></div>
            <div class="weui_loading_leaf weui_loading_leaf_5"></div>
            <div class="weui_loading_leaf weui_loading_leaf_6"></div>
            <div class="weui_loading_leaf weui_loading_leaf_7"></div>
            <div class="weui_loading_leaf weui_loading_leaf_8"></div>
            <div class="weui_loading_leaf weui_loading_leaf_9"></div>
            <div class="weui_loading_leaf weui_loading_leaf_10"></div>
            <div class="weui_loading_leaf weui_loading_leaf_11"></div>
        </div>
        <p id="p_loadContent" class="weui_toast_content">正在加载</p>
    </div>
</div>

<div class="weui_dialog_confirm" id="dialogDownload" style="display: none;">
    <div class="weui_mask"></div>
    <div class="weui_dialog">
        <div class="weui_dialog_hd"><strong class="weui_dialog_title" id="dialogTitle">提示</strong></div>
        <div id="dialogContent" class="weui_dialog_bd">请进入或下载绿豆芽APP</div>
      <div class="weui_dialog_ft">
            <a id="dialogCancle" href="javascript:$('#dialogDownload').css('display','none');" class="weui_btn_dialog default">取消</a>
            <a id="dialogConfirm" href="javascript:go_download();" class="weui_btn_dialog primary">确定</a>
        </div>
    </div>
</div>
<!--==================================================================================================================================================-->
<script>
var token=GetUrlParam("token");
var userid=GetUrlParam("userid");
var userLogo="";	
function init()
{
	url=window.location.href;
	saveFootprint(url);
	$("#loadingToast").css("display","block");
	$("#hid_pageNo").val(1);
	$("#pullDown").hide();
	$.ajax	//店铺信息
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/store/getStoreByUserid?callback=?&userid="+userid,data: {},dataType : "jsonp",	//取店铺数据
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){	
				if (json.data.store_title!=""){
					$("#td_shopName").html(json.data.store_title);
				}				
				if (json.data.store_ps!="" || json.data.store_ps.replace(/(^s*)|(s*$)/g, "").length!=0){
					$("#div_shopPsFather").css("display","block");
					$("#div_shopPs").html(json.data.store_ps);
				}
				if (json.data.store_img!=""){
					$("#div_shopFace").html(json.data.store_img);
				} else {
					$("#div_shopFace").html("<img src='img/mall_shopFace.jpg' />");
				}
				$("#td_shopName").html(json.data.store_title);
				$("#div_shopScore").html(json.data.store_integral);
				$("#div_shopCcer").html(json.data.store_totalCcer);
				userLogo=json.data.userLogo;
			}
			else
			{
				$("#loadingToast").css("display","none");
				alert(json.code);
			}
		},
		error : function(textStatus) 
		{
		}
	});		
	
	$.ajax	//用户头像
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/user/getCurrentUserToJSON?callback=?&token="+token,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){				
				if (json.data.user_id!=userid){
					//$("#div_care").css("display","block");
				}
			}
			else
			{
				$("#loadingToast").css("display","none");
				alert(json.code);
			}
		},
		error : function(textStatus) 
		{
		}
	});		
	
	loadGoods();
	setTimeout(function(){iscorll();},500);
}

function go_myShopAdd()
{
	window.location="mall_myShopAdd.html?backUrl=mall_shop";
}

function go_goods(goodsId)
{
	window.location="share_mall_goods.html?backUrl=mall_shop&token="+GetUrlParam("token")+"&goodsId="+goodsId;
}
function share(){
	$("#dialogDownload").css("display","block");
}
function loadGoods()
{
	var pageNo=$("#hid_pageNo").val();
	$.ajax	//加载商品
	({
		type : "POST",url:"http://114.55.103.71:9006/ldy/goods/getGoodsByUserid?callback=?&userId="+userid+"&status=0&pageNo="+pageNo,data: {},dataType : "jsonp",
		success : function(data) 
		{   
			var json = eval(data); 	
			if (json.code==200){
				if (json.data.length>0){
					var result="";
					//for (var i=0; i<4; i++){
					for (var i=0; i<json.data.length; i++){
						if (i==json.data.length-1){
							goodsTitle=json.data[i].title;
							goodsPrice=parseFloat(json.data[i].normsJson[0].price).toFixed(2);
							goodsCcer=json.data[i].normsJson[0].zSccerZhi;
							goodsId=json.data[i].spId;
							goodsCount=json.data[i].count;
							result+="<div class='div_goodsListFather'><div id='"+goodsId+"' onclick='go_goods(&apos;"+goodsId+"&apos;);' style='float:left; width:49.5%; background-color:#bbbbbb; vertical-align:middle;'><div class='div_goodsListImg'>"+json.data[i].coverImg+"<div class='div_saleAmount'>已销"+goodsCount+"</div></div><div style='border:1px solid #bbbbbb; background-color:#fff; border-top:none;'><div style='line-height:20px; font-size:14px; margin-left:5px; width:100%; overflow:hidden; height:20px;'>"+goodsTitle+"</div><div style='line-height:20px; color:#1AAD19; font-size:18px; font-weight:bold; margin-left:5px;'>"+goodsPrice+"<font style='font-size:14px;'>碳票</font></div><div style='line-height:20px; font-size:12px; margin-left:5px;'>附送碳:<font style='color:#C03;'>"+goodsCcer+"</font>吨</div></div></div><div style='float:right; width:49.5%;'></div></div>";											
						}
						else{			
							goodsTitleLeft=json.data[i].title;
							goodsPriceLeft=parseFloat(json.data[i].normsJson[0].price).toFixed(2);
							goodsCcerLeft=json.data[i].normsJson[0].zSccerZhi;
							goodsIdLeft=json.data[i].spId;
							goodsCountLeft=json.data[i].count;
							
							goodsTitleRight=json.data[i+1].title;
							goodsPriceRight=parseFloat(json.data[i+1].normsJson[0].price).toFixed(2);
							goodsCcerRight=json.data[i+1].normsJson[0].zSccerZhi;			
							goodsIdRight=json.data[i+1].spId;
							goodsCountRight=json.data[i+1].count;
							
							result+="<div class='div_goodsListFather'><div id='"+goodsIdLeft+"' onclick='go_goods(&apos;"+goodsIdLeft+"&apos;);' style='float:left; width:49.5%;'><div class='div_goodsListImg'>"+json.data[i].coverImg+"<div class='div_saleAmount'>已销"+goodsCountLeft+"</div></div><div style='border:1px solid #bbbbbb; background-color:#fff; border-top:none;'><div style='line-height:20px; height:20px; width:100%; overflow:hidden; font-size:14px; margin-left:5px;'>"+goodsTitleLeft+"</div><div style='line-height:20px; color:#1AAD19; font-size:18px; font-weight:bold; margin-left:5px;'>"+goodsPriceLeft+"<font style='font-size:14px;'>碳票</font></div><div style='line-height:20px; font-size:12px; margin-left:5px;'>附送碳:<font style='color:#C03;'>"+goodsCcerLeft+"</font>吨</div></div></div><div id='"+goodsIdRight+"' onclick='go_goods(&apos;"+goodsIdRight+"&apos;);' style='float:right; width:49.5%;'><div class='div_goodsListImg'>"+json.data[i+1].coverImg+"<div class='div_saleAmount'>已销"+goodsCountRight+"</div></div><div style='border:1px solid #bbbbbb; background-color:#fff; border-top:none;'><div style='line-height:20px; height:20px; font-size:14px; margin-left:5px; overflow:hidden;'>"+goodsTitleRight+"</div><div style='line-height:20px; color:#1AAD19; font-size:18px; font-weight:bold; margin-left:5px;'>"+goodsPriceRight+"<font style='font-size:14px;'>碳票</font></div><div style='line-height:20px; font-size:12px; margin-left:5px;'>附送碳:<font style='color:#C03;'>"+goodsCcerRight+"</font>吨</div></div></div></div>";	
											
							i++;
						}
					}
					
					var pageNextNo=parseInt(pageNo)+1;
					$("#div_shopGoods"+pageNo).html(result+"<div id='div_shopGoods"+pageNextNo+"' style='background-color:#fff;'></div>");	//载入商品HTML	

					pageNo++;
					$("#hid_pageNo").val(pageNo);										
					//设置载入后UI
					goodsFaceHeight();			

					$(".img_goodsFace").css("position","absolute");
					$(".img_goodsFace").css("width","100%");
					$(".img_goodsFace").css("overflow","hidden");
					$(".img_goodsFace").css("clip","rect(0px, "+divListWidth+", "+divListWidth+", 0px)");  //divListWidth来源于function goodsFaceHeight();
					
					$(".tb_goodsList").css("margin-top","0px");
					//END 设置载入后UI						
					setTimeout(function(){$("#loadingToast").css("display","none");},1000);			
				} 
				else if (pageNo==1 && json.data.length==0){
					$("#div_shopGoods1").css("background-color","");
					$("#div_shopGoods1").html("<div style='width:100%; text-align:center; margin-top:50px;'><img src='ico/ico_shopEmpty.png' style='max-height:100px; margin-bottom:10px;' /><br /><font style='font-size:14px; color:#8a8a8a;'>TA现在的货架空空</font>");
					$("#loadingToast").css("display","none");
				} 
				else {
					$("#loadingToast").css("display","none");
				}
			}
			else
			{
				$("#loadingToast").css("display","none");
				alert(json.code);
			}			
		},
		error : function(textStatus) 		
		{
			$("#loadingToast").css("display","none");
		}
	});	
}

function goodsFaceHeight()
{
	//计算显示商品图片正方形
	divListWidth=$(".div_goodsListImg").css("width");
	$(".div_goodsListImg").css("height",divListWidth);	
	//END 计算显示商品图片正方形	
	$(".div_goodsListFather").css("height",parseInt(divListWidth.replace("px",""))+70+"px");
}

function iscorll () {  
	var myScroll,  
	pullDown = $("#pullDown"),  
	pullDownLabel = $(".pullDownLabel"),  

	loadingStep = 0;//加载状态0默认，1显示加载状态，2执行加载数据，只有当为0时才能再次加载，这是防止过快拉动刷新  
//  
	pullDown.hide();  
  
	myScroll = new IScroll("#wrapper", {  
		preventDefault:false,
		scrollbars: false,  
		mouseWheel: false,  
		interactiveScrollbars: true,  
		shrinkScrollbars: 'scale',  
		fadeScrollbars: true,  
		scrollY:true,  
		probeType: 2,  
		bindToWrapper:true  
	});  
	myScroll.on("scroll",function(){  
		if(loadingStep == 0 && !pullDown.attr("class").match('refresh|loading')){  
			if(this.y > 40){//下拉刷新操作  
				$(".pulldown-tips").hide();  
				pullDown.addClass("refresh").show();  
				pullDownLabel.text("松手刷新数据");  
				loadingStep = 1;  
				myScroll.refresh();  				
			}else if(this.y < (this.maxScrollY - 60)){//上拉加载更多  
				loadingStep = 1;  
				$("#p_loadContent").html("正在加载");
				$("#loadingToast").css("display","block");
				pullUpAction();  
			}  
		}  
	});  
	myScroll.on("scrollEnd",function(){  
		if(loadingStep == 1){  
			if( pullDown.attr("class").match("refresh") ){//下拉刷新操作  
				pullDown.removeClass("refresh").addClass("loading");  
				$("#p_loadContent").html("正在刷新");
				$("#loadingToast").css("display","block");
				loadingStep = 2;  
				pullDownAction();  
			}  
		}  
	});  

	function pullDownAction(){  
		setTimeout(function(){  
			init();
			pullDown.attr('class','').hide();  
			loadingStep = 0;  
			$(".pulldown-tips").show(); 
			$("#loadingToast").css("display","none");
		},500);  
		setTimeout(function(){myScroll.refresh();},1000);
	}		
	function pullUpAction(){  
		setTimeout(function(){  
			loadingStep = 0;  
			loadGoods();			
		},500);  
		setTimeout(function(){myScroll.refresh();},1000);
	}  
  
    document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);  
}  	
</script>
